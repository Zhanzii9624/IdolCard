<!DOCTYPE html>
<html lang="zh-TW">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÂÅ∂ÂÉèÂç°ÁâáÁ≥ªÁµ±</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Noto+Sans+TC:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <style>
    :root {
      --primary-color: #ec4899;
      --primary-dark: #db2777;
      --primary-light: #f472b6;
      --secondary-color: #8b5cf6;
      --accent-color: #06b6d4;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --error-color: #ef4444;
      --info-color: #06b6d4;
      --bg-primary: linear-gradient(135deg, #fdf2f8 0%, #fae8ff 50%, #f0f9ff 100%);
      --bg-secondary: #ffffff;
      --bg-card: rgba(255, 255, 255, 0.8);
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --border-color: rgba(236, 72, 153, 0.2);
      --shadow-primary: 0 25px 50px -12px rgba(236, 72, 153, 0.4);
      --shadow-card: 0 10px 25px -3px rgba(236, 72, 153, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --gradient-primary: linear-gradient(135deg, #ec4899 0%, #db2777 50%, #be185d 100%);
      --gradient-secondary: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 50%, #6d28d9 100%);
      --gradient-accent: linear-gradient(135deg, #06b6d4 0%, #0891b2 50%, #0e7490 100%);
      --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --gradient-bg: linear-gradient(135deg, #fdf2f8 0%, #fae8ff 25%, #f0f9ff 50%, #ecfeff 75%, #fdf2f8 100%);
      --gradient-card: linear-gradient(145deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', 'Noto Sans TC', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: var(--text-primary);
      background: var(--bg-primary);
      background-attachment: fixed;
      min-height: 100vh;
      position: relative;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: var(--gradient-bg);
      z-index: -2;
    }

    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image:
        radial-gradient(circle at 20% 30%, rgba(236, 72, 153, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 40% 80%, rgba(6, 182, 212, 0.1) 0%, transparent 40%),
        radial-gradient(circle at 90% 70%, rgba(245, 158, 11, 0.1) 0%, transparent 40%);
      z-index: -1;
    }

    .header {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(236, 72, 153, 0.2);
      padding: 1.5rem 0;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 4px 20px rgba(236, 72, 153, 0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    h1 {
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 3rem;
      font-weight: 800;
      letter-spacing: -0.05em;
      text-shadow: 0 4px 20px rgba(236, 72, 153, 0.3);
      font-family: 'Poppins', sans-serif;
    }

    h1::after {
      content: '‚ú®';
      margin-left: 0.5rem;
      font-size: 2rem;
      filter: drop-shadow(0 0 10px rgba(236, 72, 153, 0.5));
    }

    .wallet-section {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .wallet-balance-btn {
      background: var(--gradient-accent);
      border: none;
      cursor: pointer;
      padding: 0.75rem;
      border-radius: 20px;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-card);
    }

    .wallet-balance-btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 15px 30px rgba(6, 182, 212, 0.4);
    }

    .wallet-balance-btn img {
      width: 32px;
      height: 32px;
      border-radius: 8px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }

    .wallet-connect-card {
      background: var(--gradient-card);
      border-radius: 25px;
      padding: 2.5rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
    }

    .wallet-connect-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .wallet-connect-card::after {
      content: 'üíé';
      position: absolute;
      top: 1rem;
      right: 1.5rem;
      font-size: 1.5rem;
      opacity: 0.3;
    }

    .connect-btn {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 1.25rem 2.5rem;
      border-radius: 25px;
      cursor: pointer;
      font-size: 1.1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      box-shadow: var(--shadow-card);
    }

    .connect-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .connect-btn:hover::before {
      left: 100%;
    }

    .connect-btn:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 15px 35px rgba(236, 72, 153, 0.4);
    }

    .connect-btn:active {
      transform: translateY(0);
    }

    .tabs {
      display: flex;
      background: var(--gradient-card);
      border-radius: 25px;
      padding: 0.75rem;
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      overflow-x: auto;
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-card);
    }

    .tab {
      padding: 1rem 1.5rem;
      cursor: pointer;
      border-radius: 20px;
      transition: all 0.3s ease;
      white-space: nowrap;
      font-weight: 500;
      color: var(--text-secondary);
      position: relative;
      font-family: 'Poppins', sans-serif;
    }

    .tab:hover {
      color: var(--text-primary);
      background: rgba(236, 72, 153, 0.1);
      transform: translateY(-2px);
    }

    .tab.active {
      background: var(--gradient-primary);
      color: white;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(236, 72, 153, 0.3);
      transform: translateY(-2px);
    }

    .tab.active::after {
      content: '‚≠ê';
      margin-left: 0.5rem;
      font-size: 0.9rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .content-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .card {
      background: var(--gradient-card);
      border-radius: 25px;
      padding: 2.5rem;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-card);
      backdrop-filter: blur(20px);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }

    .card:hover {
      transform: translateY(-8px);
      box-shadow: var(--shadow-primary);
      border-color: var(--primary-color);
    }

    h2,
    h3 {
      color: var(--text-primary);
      margin-bottom: 1.5rem;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
    }

    h2 {
      font-size: 1.75rem;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      position: relative;
    }

    h2::after {
      content: 'üíñ';
      margin-left: 0.5rem;
      font-size: 1.2rem;
      filter: drop-shadow(0 0 8px rgba(236, 72, 153, 0.4));
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.9rem;
    }

    input,
    select {
      width: 100%;
      padding: 1rem;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      background: var(--bg-secondary);
    }

    input::placeholder {
      color: var(--text-secondary);
    }

    button {
      background: var(--gradient-primary);
      color: white;
      border: none;
      padding: 1rem 1.75rem;
      border-radius: 20px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Poppins', sans-serif;
      box-shadow: var(--shadow-card);
    }

    button::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    button:hover::before {
      left: 100%;
    }

    button:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 12px 25px rgba(236, 72, 153, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--gradient-secondary);
    }

    .btn-secondary:hover {
      box-shadow: 0 12px 25px rgba(139, 92, 246, 0.4);
    }

    .btn-success {
      background: var(--gradient-success);
    }

    .btn-success:hover {
      box-shadow: 0 12px 25px rgba(16, 185, 129, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    }

    .btn-danger:hover {
      box-shadow: 0 12px 25px rgba(239, 68, 68, 0.4);
    }

    .status {
      margin-top: 1rem;
      padding: 1rem;
      border-radius: 12px;
      font-weight: 500;
      border-left: 4px solid;
    }

    .success {
      background: rgba(16, 185, 129, 0.1);
      color: var(--success-color);
      border-color: var(--success-color);
    }

    .error {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error-color);
      border-color: var(--error-color);
    }

    .info {
      background: rgba(59, 130, 246, 0.1);
      color: var(--info-color);
      border-color: var(--info-color);
    }

    .warning {
      background: rgba(245, 158, 11, 0.1);
      color: var(--warning-color);
      border-color: var(--warning-color);
    }

    /* Card Display Styles */
    .idol-card {
      background: var(--gradient-card);
      border-radius: 25px;
      overflow: hidden;
      box-shadow: var(--shadow-card);
      transition: all 0.4s ease;
      border: 1px solid var(--border-color);
      position: relative;
    }

    .idol-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(236, 72, 153, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 1;
    }

    .idol-card:hover::before {
      opacity: 1;
    }

    .idol-card:hover {
      transform: translateY(-10px) rotateY(3deg) scale(1.02);
      box-shadow: var(--shadow-primary);
      border-color: var(--primary-color);
    }

    .idol-card-image {
      width: 100%;
      height: 300px;
      background: linear-gradient(135deg, #fdf2f8 0%, #fae8ff 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 1.2rem;
      position: relative;
      overflow: hidden;
    }

    .idol-card-image::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(45deg, rgba(236, 72, 153, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .idol-card:hover .idol-card-image::after {
      opacity: 1;
    }

    .idol-card-image img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      object-position: center;
      background: white;
      border-radius: 15px 15px 0 0;
      position: relative;
      z-index: 2;
    }

    .idol-card-image .placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      color: var(--text-secondary);
      font-size: 1rem;
      padding: 2rem;
      font-family: 'Poppins', sans-serif;
      position: relative;
      z-index: 2;
    }

    .idol-card-content {
      padding: 2rem;
      position: relative;
      z-index: 2;
    }

    .idol-card-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
      font-family: 'Poppins', sans-serif;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .idol-card-info {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      font-weight: 500;
      line-height: 1.8;
    }

    .idol-card-price {
      font-size: 1.75rem;
      font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 1.5rem;
      font-family: 'Poppins', sans-serif;
      position: relative;
    }

    .idol-card-price::before {
      content: 'üí∞';
      margin-right: 0.5rem;
      font-size: 1.2rem;
    }

    .idol-card-actions {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .idol-card-actions button {
      flex: 1;
      min-width: 140px;
      font-size: 0.9rem;
      padding: 0.875rem 1.25rem;
    }


    /* Transaction History Styles */
    .transaction-history {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top: 1px solid rgba(236, 72, 153, 0.2);
    }

    .transaction-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 0;
      border-bottom: 1px solid rgba(236, 72, 153, 0.1);
      background: linear-gradient(90deg, rgba(236, 72, 153, 0.02) 0%, transparent 100%);
      border-radius: 10px;
      margin-bottom: 0.5rem;
      padding-left: 1rem;
      padding-right: 1rem;
    }

    .transaction-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .transaction-date {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .transaction-action {
      font-weight: 600;
      color: var(--text-primary);
      font-family: 'Poppins', sans-serif;
    }

    .transaction-amount {
      font-weight: 700;
      color: var(--primary-color);
      font-family: 'Poppins', sans-serif;
    }

    /* Market Grid */
    .market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 1.5rem;
      margin-top: 1rem;
    }

    /* Table Styles */
    .modern-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: var(--gradient-card);
      border-radius: 20px;
      overflow: hidden;
      margin-top: 1rem;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-card);
    }

    .modern-table th {
      background: var(--gradient-primary);
      color: white;
      padding: 1.25rem;
      text-align: left;
      font-weight: 700;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-family: 'Poppins', sans-serif;
      position: relative;
    }

    .modern-table th::after {
      content: '‚ú®';
      position: absolute;
      right: 1rem;
      opacity: 0.7;
    }

    .modern-table td {
      padding: 1.25rem;
      border-bottom: 1px solid rgba(236, 72, 153, 0.1);
      color: var(--text-primary);
      font-weight: 500;
      background: rgba(255, 255, 255, 0.5);
    }

    .modern-table tr:hover td {
      background: rgba(236, 72, 153, 0.05);
      transform: scale(1.01);
      transition: all 0.3s ease;
    }

    .modern-table tr:last-child td {
      border-bottom: none;
    }

    /* Trade Status Badges */
    .trade-status {
      padding: 0.75rem 1.25rem;
      border-radius: 25px;
      font-size: 0.8rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-family: 'Poppins', sans-serif;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      border: 2px solid transparent;
      position: relative;
      overflow: hidden;

      white-space: nowrap;
      display: inline-block;
    }

    .trade-status::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s;
    }

    .trade-status:hover::before {
      left: 100%;
    }

    .status-created {
      background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
      color: white;
      border-color: #06b6d4;
    }

    .status-buyer-signed {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      border-color: #f59e0b;
    }

    .status-seller-signed {
      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
      color: white;
      border-color: #8b5cf6;
    }

    .status-completed {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      border-color: #10b981;
    }

    /* Loading Animation */
    .loader {
      border: 4px solid rgba(236, 72, 153, 0.2);
      border-top: 4px solid var(--primary-color);
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite, pulse 2s ease-in-out infinite alternate;
      display: inline-block;
      margin-left: 0.75rem;
      vertical-align: middle;
      box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 20px rgba(236, 72, 153, 0.3);
      }

      100% {
        box-shadow: 0 0 30px rgba(236, 72, 153, 0.6);
      }
    }

    /* Modal Styles */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(236, 72, 153, 0.1);
      backdrop-filter: blur(15px);
      z-index: 9999;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }

    .modal-content {
      background: var(--gradient-card);
      padding: 2.5rem;
      border-radius: 25px;
      width: 100%;
      max-width: 900px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-primary);
      backdrop-filter: blur(20px);
    }

    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
      border-radius: 25px 25px 0 0;
    }

    .modal-close {
      position: absolute;
      top: 1.5rem;
      right: 1.5rem;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.3s ease;
      background: rgba(236, 72, 153, 0.1);
      border: none;
      padding: 0.75rem;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal-close:hover {
      color: var(--primary-color);
      background: rgba(236, 72, 153, 0.2);
      transform: scale(1.1) rotate(90deg);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }

      .content-grid {
        grid-template-columns: 1fr;
      }

      .market-grid {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 2.5rem;
      }

      .header-content {
        flex-direction: column;
        gap: 1.5rem;
      }

      .wallet-section {
        width: 100%;
        justify-content: center;
      }

      .tabs {
        overflow-x: auto;
        padding: 0.5rem;
      }

      .tab {
        padding: 0.875rem 1.25rem;
        font-size: 0.9rem;
      }

      .idol-card:hover {
        transform: translateY(-5px) scale(1.01);
      }

      .card {
        padding: 2rem;
      }

      .modal-content {
        padding: 2rem;
        margin: 1rem;
      }

      .idol-card-actions {
        flex-direction: column;
      }

      .idol-card-actions button {
        min-width: auto;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 2rem;
      }

      .wallet-connect-card {
        padding: 2rem;
      }

      .card {
        padding: 1.5rem;
      }

      .idol-card-content {
        padding: 1.5rem;
      }

      .tab {
        padding: 0.75rem 1rem;
        font-size: 0.85rem;
      }
    }

    /* Hide elements initially */
    .tabs,
    .tab-content,
    .container .content-grid {
      display: none;
    }

    .tabs.show,
    .container .content-grid.show {
      display: flex;
    }

    .content-grid.show {
      display: grid;
    }
  </style>
</head>

<body>
  <div class="header">
    <div class="header-content">
      <h1>ÂÅ∂ÂÉèÂç°ÁâáÁ≥ªÁµ±</h1>
      <div class="wallet-section">
        <button id="walletBalanceBtn" class="wallet-balance-btn">
          <img src="./wallet.webp" alt="Êü•ÁúãÈå¢ÂåÖÈ§òÈ°ç" onerror="this.style.display='none'">
        </button>
        <button id="connectWalletBtn" class="connect-btn">ÈÄ£Êé•Èå¢ÂåÖ</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="wallet-connect-card">
      <h2>Èå¢ÂåÖÈÄ£Êé•</h2>
      <div id="connection-status" class="status info">Ë´ãÈÄ£Êé•ÊÇ®ÁöÑÈå¢ÂåÖ‰ª•‰ΩøÁî®ÂÖ®ÈÉ®ÂäüËÉΩ</div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="purchase">ÁôºË°åÂç°Áâá</div>
      <div class="tab" data-tab="myCards">ÊàëÁöÑÂç°Áâá</div>
      <div class="tab" data-tab="market">Â∏ÇÂ†¥‰∫§Êòì</div>
      <div class="tab" data-tab="admin">ÁÆ°ÁêÜÂäüËÉΩ</div>
      <div class="tab" data-tab="history">ÈÅéÂæÄ‰∫§Êòì</div>
    </div>

    <div class="content-grid">
      <!-- Ë≥ºË≤∑Âç°Áâá Tab -->
      <div id="purchase" class="tab-content active">
        <!-- ÂÖ¨Âè∏ËßíËâ≤ -->
        <div class="role-content company-role">
          <div class="card">
            <h2>Ë®≠ÁΩÆÂç°ÁâáË≥áË®äËàáÂÉπÊ†º</h2>
            <div class="form-group">
              <label class="form-label">ÂÅ∂ÂÉèÂúòÈ´îÂêçÁ®±</label>
              <input type="text" id="idol-group" placeholder="‰æãÂ¶ÇÔºöBTS">
            </div>
            <div class="form-group">
              <label class="form-label">ÊàêÂì°ÂßìÂêç</label>
              <input type="text" id="idol-member" placeholder="‰æãÂ¶ÇÔºöJungkook">
            </div>
            <div class="form-group">
              <label class="form-label">Âç°ÁâáÁ∑®Ëôü</label>
              <input type="text" id="card-number" placeholder="‰æãÂ¶ÇÔºö001">
            </div>
            <div class="form-group">
              <label class="form-label">Âç°Áâá‰∏äÊû∂ÂÉπ (ETH)</label>
              <input type="number" id="list-price" placeholder="0.001" step="0.001">
            </div>
            <div class="form-group">
              <label class="form-label">ÁÖßÁâá URI</label>
              <input type="text" id="photo-uri" placeholder="ipfs://xxx Êàñ https://...">
            </div>
            <div class="form-group">
              <label class="form-label">ÂêàÁ¥ÑÂÖßÈÉ®ÂÉπÊ†º (ETH)</label>
              <input type="number" id="new-price" placeholder="0.001" step="0.001">
            </div>
            <div class="form-group">
              <label class="form-label">ÁôºË°åÂºµÊï∏</label>
              <input type="number" id="card-amount" placeholder="10">
            </div>
            <button id="set-price-btn" class="btn-success">Ë®≠ÁΩÆÂç°ÁâáË≥áË®ä</button>
            <div id="set-price-status"></div>
          </div>
        </div>

        <!-- ÊôÆÈÄöÁî®Êà∂ËßíËâ≤ -->
        <div class="role-content buyer-role" style="display: none;">
          <div class="card">
            <h2>ÂÖ¨Âè∏Ë≤©ÂîÆÂç°Áâá</h2>
            <div id="available-cards-market" class="market-grid">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>ËΩâÂîÆÂç°ÁâáÂ∏ÇÂ†¥</h2>
            <div id="resale-cards-market" class="market-grid">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>Á∂ÅÂÆöÂç°Áâá UID</h2>
            <div class="form-group">
              <label class="form-label">Âç°Áâá UID</label>
              <input type="text" id="card-uid" placeholder="Ëº∏ÂÖ•Âç°Áâá UID">
            </div>
            <button id="request-card-btn">Ë´ãÊ±ÇÁ∂ÅÂÆö</button>
            <div id="request-status"></div>
          </div>
        </div>

        <div id="purchase-status" class="card" style="margin-top: 2rem;"></div>
      </div>

      <!-- ÊàëÁöÑÂç°Áâá Tab -->
      <div id="myCards" class="tab-content">
        <div class="role-content company-role">
          <div class="card">
            <h2>Âç°ÁâáÁôºË°åÁµ±Ë®à</h2>
            <div id="card-stats">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content buyer-role" style="display: none;">
          <div class="card">
            <h2>ÊìÅÊúâÂç°Áâá</h2>
            <div id="my-cards-list-first" class="market-grid">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content second-hand-role" style="display: none;">
          <div class="card">
            <h2>‰∏äÊû∂Âç°Áâá</h2>
            <div id="my-cards-list-second" class="market-grid">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>ÂâµÂª∫‰∫§Êòì</h2>
            <div class="form-group">
              <label class="form-label">ÈÅ∏ÊìáÂç°Áâá</label>
              <select id="card-to-sell">
                <option value="">-- ÈÅ∏ÊìáÂç°Áâá --</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Èä∑ÂîÆÂÉπÊ†º (ETH)</label>
              <input type="number" id="selling-price" placeholder="0.01" step="0.01">
            </div>
            <button id="resale-btn" class="btn-secondary">‰∏äÊû∂‰∫åÊâãÂç°Áâá</button>
            <div id="create-trade-status"></div>
          </div>
        </div>
      </div>

      <!-- Â∏ÇÂ†¥‰∫§Êòì Tab -->
      <div id="market" class="tab-content">
        <div class="role-content company-role">
          <div class="card">
            <h2>ÊâÄÊúâ‰∫§ÊòìÊ¶ÇË¶Ω</h2>
            <div id="all-trades-overview">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content buyer-role" style="display: none;">
          <div class="card">
            <h2>ÂèØÁî®‰∫§Êòì</h2>
            <div id="available-trades-first">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>ÊàëÁöÑÈä∑ÂîÆ</h2>
            <div id="my-sales-first">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content second-hand-role" style="display: none;">
          <div class="card">
            <h2>ÂèØÁî®‰∫§Êòì</h2>
            <div id="available-trades-second">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>ÊàëÁöÑ‰∫§ÊòìÁÆ°ÁêÜ</h2>
            <div id="my-trades-second">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- ÁÆ°ÁêÜÂäüËÉΩ Tab -->
      <div id="admin" class="tab-content">
        <div class="role-content company-role">
          <div class="card">
            <h2>ÂØ©ÊâπÂç°ÁâáË´ãÊ±Ç</h2>
            <div id="pending-requests">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>‰∫§ÊòìÊï∏ÊìöÂàÜÊûê</h2>
            <div id="trade-analytics">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content buyer-role" style="display: none;">
          <div class="card">
            <h2>ÁÑ°ÁÆ°ÁêÜÊ¨äÈôê</h2>
            <p>ÊÇ®ÁõÆÂâçÁöÑËßíËâ≤ÁÑ°Ê≥ïË®™ÂïèÁÆ°ÁêÜÂäüËÉΩÔºåË´ãÂàáÊèõÂà∞„ÄåÂÖ¨Âè∏„ÄçËßíËâ≤„ÄÇ</p>
          </div>
        </div>
      </div>
      <!-- ÈÅéÂæÄ‰∫§Êòì Tab -->
      <div id="history" class="tab-content">
        <div class="role-content company-role">
          <div class="card">
            <h2>ÂÖ¨Âè∏‰∫§ÊòìÁ¥ÄÈåÑ</h2>
            <div id="history-records-company" style="min-height: 500px;">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>

        <div class="role-content buyer-role" style="display: none;">
          <div class="card history-card">
            <h2>ÊàëÁöÑ‰∫§ÊòìÁ¥ÄÈåÑ</h2>
            <div id="history-records-buyer" style="min-height: 500px;">
              <p>ËºâÂÖ•‰∏≠...
              <div class="loader"></div>
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal -->
    <div id="card-modal" class="modal">
      <div class="modal-content">
        <button id="card-modal-close" class="modal-close">&times;</button>
        <h2>Âç°Áâá‰∫§ÊòìË©≥ÊÉÖ</h2>
        <div id="card-modal-content">
          <p>ËºâÂÖ•‰∏≠...
          <div class="loader"></div>
          </p>
        </div>
      </div>
    </div>

    <script type="module">
      import { initEthers, signer } from './js/ethers-init.js';

      // ÂêàÁ¥Ñ ABI (Ê†πÊìöÂØ¶ÈöõÂêàÁ¥ÑË™øÊï¥)
      const contractABI = [
        "function owner() external view returns (address)",
        "event CardPurchased(address indexed buyer, uint256 amount, string uid)",
        "event CardRequested(address indexed buyer, string uid)",
        "event CardApproved(string uid, address indexed buyer, uint256 tokenId)",
        "event CardRequestRejected(string uid, address buyer)",

        // CardManager Áõ∏ÈóúÂáΩÂºè
        "function cardManager() view returns (address)",
        "function getCompanyCards() external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
        "function getAvailableCards() external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
        "function getPendingCardRequests() external view returns (tuple(string uid, address buyer, uint256 amount, uint256 timestamp)[])",
        "function getUserCards(address user) external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
        "function purchaseSpecificCard(string uid, address recipient) external payable returns (string)",
        "function bindCardUID(string uid, address recipient) external",
        "function getCardPrice() external view returns (uint256)",
        "function requestCard(string uid, address recipient) external",
        "function approveTransfer(string uid) external",
        "function rejectTransfer(string uid) external",
        "function setCardPrice(uint256 newPrice, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, uint256 amount) external returns (string)",
        "function listCardForResale(string uid, uint256 price) external",
        "function getNFTHolder(string memory uid) external view returns (address)",
        "function getResaleCards() external view returns (tuple(string uid, string idolGroup, string member, string cardNumber, uint256 listPrice, string photoURI, bool isSold)[])",
        "function cancelResale(string uid) external",

        // TradeManager Áõ∏ÈóúÂáΩÂºè
        "function tradeManager() view returns (address)",
        "function createTrade(string uid, uint256 price) external",
        "function buyerSign(uint256 tradeId) external payable",
        "function sellerSign(uint256 tradeId) external",
        "function finalize(uint256 tradeId) external",
        "function getUserTrades(address user) external view returns (tuple(uint256 tradeId, uint256 tokenId, address seller, address buyer, uint256 price, uint256 timestamp, uint8 status)[] memory)",
        "function getTradeAnalytics() external view returns (uint256 totalTrades, uint256 completedTrades, uint256 pendingTrades, uint256 totalVolume)",
        "function getAvailableTrades() external view returns (tuple(uint256 tradeId, uint256 tokenId, address seller, address buyer, uint256 price, uint256 timestamp, uint8 status)[] memory)",
        "function getTrade(uint256 tradeId) external view returns (uint256 tokenId, address seller, address buyer, uint256 price, uint8 status, uint256 deadline)",
        "function uidToTradeIds(string) view returns (uint256[])",
        "function getTradesByUID(string memory uid) external view returns (tuple(uint256 tradeId, uint256 tokenId, address seller, address buyer, uint256 price, uint256 timestamp, uint8 status)[] memory)",
        "function tradeCounter() view returns (uint256)",
        "function recordPrimaryTrade(string memory uid, uint256 tokenId, address buyer, uint256 price) external",
        "function recordSecondaryTrade(string memory uid, uint256 tokenId, address seller, address buyer, uint256 price) external",
        "function setUidToTokenId(string memory uid, uint256 tokenId) external",
        "function uidToTokenId(string) view returns (uint256)",
        "function purchaseResaleCard(string uid,address recipient) external payable"
      ];

      // ÁãÄÊÖãËÆäÊï∏
      let contract;
      let userAccount;
      let isOwner = false;
      let contractAddress;
      let cardManagerAddress;
      let tradeManagerAddress;

      // DOM ËºâÂÖ•ÂÆåÊàêÂæåÂü∑Ë°å
      window.addEventListener('DOMContentLoaded', () => {
        fetch('./contract-addresses.json')
          .then(res => {
            console.log("‚úÖ ÊàêÂäü fetch contract-addresses.json");
            return res.json();
          })
          .then(async (addresses) => {
            console.log("‚úÖ JSON ÂÖßÂÆπÁÇ∫", addresses);
            contractAddress = addresses.IdolCardSystem;
            cardManagerAddress = addresses.CardManager;
            tradeManagerAddress = addresses.TradeManager;
          })
          .catch(err => {
            console.error("ÈåØË™§‰∫Ü!", err);
          });

        // ÂàùÂßãÂåñÊ®ôÁ±§È†ÅÂàáÊèõ
        initTabs();

        // Áç≤ÂèñÈÄ£Êé•Èå¢ÂåÖÊåâÈàï
        const connectBtn = document.getElementById('connectWalletBtn');
        if (!connectBtn) return;

        // ÂàùÂßãÈªûÊìäÁ∂ÅÂÆö
        connectBtn.addEventListener('click', connectWallet);

        // Á∂ÅÂÆöÂÖ∂‰ªñÊåâÈàï‰∫ã‰ª∂Ôºå‰ΩÜÊö´ÊôÇÁ¶ÅÁî®
        const buttons = document.querySelectorAll('button:not(#connectWalletBtn):not(.role-btn)');
        buttons.forEach(btn => {
          btn.disabled = true;
        });

        // ÂêÑËßíËâ≤ÂäüËÉΩÊåâÈàï‰∫ã‰ª∂
        // ÂÖ¨Âè∏ËßíËâ≤
        document.getElementById('set-price-btn').addEventListener('click', setCardPrice);

        // Á¨¨‰∏ÄÊâãË≤∑ÂÆ∂ËßíËâ≤
        document.getElementById('request-card-btn').addEventListener('click', bindCard);

        // Á¨¨‰∫åÊâãË≤∑ÂÆ∂/Ë≥£ÂÆ∂ËßíËâ≤
        document.getElementById('resale-btn').addEventListener('click', resaleCard);
      });

      document.getElementById('walletBalanceBtn').addEventListener('click', async () => {
        if (!userAccount) {
          alert('Ë´ãÂÖàÈÄ£Êé•Èå¢ÂåÖ');
          return;
        }
        try {
          const balanceWei = await window.ethereum.request({
            method: 'eth_getBalance',
            params: [userAccount, 'latest']
          });
          const balanceEth = ethers.utils.formatEther(balanceWei);
          alert(`ÁõÆÂâçÁöÑÈ§òÈ°çÊòØ ${balanceEth} ETH`);
        } catch (error) {
          console.error("Êü•Ë©¢È§òÈ°çÂ§±Êïó:", error);
          alert('Êü•Ë©¢È§òÈ°çÂ§±ÊïóÔºåË´ãÁ®çÂæåÈáçË©¶');
        }
      });

      // Áï∂ÂâçÈÅ∏ÊìáÁöÑËßíËâ≤
      let currentRole = 'company';

      // ÂàáÊèõËßíËâ≤
      function switchRole(role) {
        currentRole = role;

        let roleDescription = '';

        switch (role) {
          case 'company':
            roleDescription = 'Áï∂ÂâçËßíËâ≤: ÂÖ¨Âè∏ - Ë≤†Ë≤¨ÁôºË°åÂç°ÁâáÂíåÂØ©ÊâπÂç°ÁâáÁ∂ÅÂÆöË´ãÊ±Ç';
            document.querySelector('.tab[data-tab="purchase"]').textContent = 'ÁôºË°åÂç°Áâá';
            break;
          case 'buyer':
            roleDescription = 'Áï∂ÂâçËßíËâ≤: ÊôÆÈÄöÁî®Êà∂ - ÂèØ‰ª•Ë≥ºË≤∑Âç°Áâá„ÄÅË´ãÊ±ÇÁ∂ÅÂÆöËàáÂ∏ÇÂ†¥‰∫§Êòì';
            document.querySelector('.tab[data-tab="purchase"]').textContent = 'Ë≥ºË≤∑Âç°Áâá';
            break;
        }

        // Êõ¥Êñ∞ÂÖßÂÆπÈ°ØÁ§∫
        document.querySelectorAll('.role-content').forEach(content => {
          content.style.display = 'none';
        });

        if (role === 'company') {
          document.querySelectorAll('.company-role').forEach(content => {
            content.style.display = 'block';
          });
        } else {
          document.querySelectorAll('.buyer-role').forEach(content => {
            content.style.display = 'block';
          });
        }

        // Â¶ÇÊûúÈå¢ÂåÖÂ∑≤ÈÄ£Êé•ÔºåÈáçÊñ∞ËºâÂÖ•Â∞çÊáâËßíËâ≤ÁöÑÊï∏Êìö
        if (contract && userAccount) {
          loadRoleSpecificData(role);
        }
      }

      async function awaitContractsReady() {
        while (!contractAddress || !cardManagerAddress || !tradeManagerAddress) {
          console.log("‚è≥ Á≠âÂæÖÂêàÁ¥ÑÂú∞ÂùÄËºâÂÖ•...");
          await new Promise(resolve => setTimeout(resolve, 200));
        }
        console.log("‚úÖ ÂêàÁ¥ÑÂú∞ÂùÄÂ∑≤Ê∫ñÂÇôÂ•Ω");
      }

      // ÈÄ£Êé•Èå¢ÂåÖ
      async function connectWallet() {
        await awaitContractsReady();

        const connectBtn = document.getElementById('connectWalletBtn');
        const connectionStatus = document.getElementById('connection-status');

        try {
          connectionStatus.innerHTML = '<span>ÈÄ£Êé•‰∏≠... <div class="loader"></div></span>';
          connectionStatus.className = 'status info';

          const result = await initEthers(contractABI, contractAddress);
          contract = result.contract;
          userAccount = result.userAddress;
          console.log("‰ΩøÁî®ËÄÖÂ∏≥Êà∂:", userAccount);
          console.log("ÂêàÁ¥ÑÊòØÂê¶ÈÄ£Êé•ÊàêÂäüÔºü", contract);

          connectBtn.textContent = `Â∑≤ÈÄ£Êé•: ${userAccount.slice(0, 6)}...${userAccount.slice(-4)}`;
          connectionStatus.textContent = `Â∑≤ÈÄ£Êé•Âà∞Èå¢ÂåÖÔºö${userAccount}`;
          connectionStatus.className = 'status success';

          // Ê™¢Êü•ÊòØÂê¶ÁÇ∫ÂêàÁ¥ÑÊìÅÊúâËÄÖ
          const owner = await contract.owner();
          isOwner = (owner.toLowerCase() === userAccount.toLowerCase());
          console.log("Áï∂ÂâçÁî®Êà∂ÊòØÂê¶ÁÇ∫ÊìÅÊúâËÄÖÔºü", isOwner);
          console.log("‰ΩøÁî®ÁöÑÂêàÁ¥ÑÂú∞ÂùÄ:", contractAddress);

          // È°ØÁ§∫ÊàñÈö±ËóèÁÆ°ÁêÜÂì°È†ÅÁ±§
          const adminTab = document.querySelector('.tab[data-tab="admin"]');
          if (isOwner) {
            if (adminTab) adminTab.style.display = 'block';
            currentRole = 'company';
          } else {
            if (adminTab) adminTab.style.display = 'none';
            currentRole = 'buyer';
          }

          // ÊéßÂà∂È°ØÁ§∫ÂÖ¨Âè∏ËßíËâ≤ÊàñË≤∑ÂÆ∂ËßíËâ≤ÂÖßÂÆπ
          if (isOwner) {
            document.querySelectorAll('.buyer-role, .second-hand-role').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.company-role').forEach(el => el.style.display = 'block');
          } else {
            document.querySelectorAll('.company-role').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.buyer-role, .second-hand-role').forEach(el => el.style.display = 'block');
            await loadResaleCardsMarket();
          }

          // È°ØÁ§∫Ê®ôÁ±§ËàáÂÆπÂô®
          const tabsContainer = document.querySelector('.tabs');
          const mainContainer = document.querySelector('.content-grid');
          if (tabsContainer) {
            tabsContainer.style.display = 'flex';
            tabsContainer.classList.add('show');
          }
          if (mainContainer) {
            mainContainer.style.display = 'grid';
            mainContainer.classList.add('show');
          }

          // ÂïüÁî®Èô§ÈÄ£Êé•ÊåâÈàïÂ§ñÊâÄÊúâÊåâÈàï
          document.querySelectorAll('button:not(#connectWalletBtn)').forEach(btn => btn.disabled = false);

          // Âè™Âú®Á¢∫ÂÆöË∫´‰ªΩÂæåÔºåÊâçËºâÂÖ•Ë≥áÊñô
          await loadRoleSpecificData(currentRole);

          // Áõ£ËÅΩÂ∏≥Êà∂ËÆäÂãï‰∫ã‰ª∂ÔºåÂà∑Êñ∞È†ÅÈù¢
          if (window.ethereum) {
            window.ethereum.on('accountsChanged', () => {
              window.location.reload();
            });
          }

          // Ë®≠ÂÆöÂêàÁ¥Ñ‰∫ã‰ª∂Áõ£ËÅΩÂô®
          setupEventListeners();

        } catch (error) {
          console.error("ÈÄ£Êé• MetaMask Â§±Êïó:", error);
          connectionStatus.textContent = 'ÈÄ£Êé•Èå¢ÂåÖÂ§±ÊïóÔºåË´ãÈáçË©¶„ÄÇ';
          connectionStatus.className = 'status error';
        }
      }

      // Ê†πÊìöËßíËâ≤ËºâÂÖ•ÁâπÂÆöÊï∏Êìö
      async function loadRoleSpecificData(role) {
        try {
          // Áç≤ÂèñÂç°ÁâáÂÉπÊ†ºÔºàÂêÑËßíËâ≤ÈÉΩÈúÄË¶ÅÔºâ
          const priceWei = await contract.getCardPrice();
          const priceEth = ethers.utils.formatEther(priceWei);

          // Êõ¥Êñ∞ÂêÑËßíËâ≤È°ØÁ§∫ÁöÑÂÉπÊ†º
          const priceElement = document.getElementById('card-price');
          if (priceElement) {
            priceElement.textContent = `Âç°ÁâáÂÉπÊ†º: ${priceEth} ETH`;
          }

          // Ê†πÊìöËßíËâ≤ËºâÂÖ•‰∏çÂêåÊï∏Êìö
          switch (role) {
            case 'company':
              if (isOwner) {
                loadPendingRequests();
                loadCardStats();
                loadAllTradesOverview();
                loadTradeAnalytics();
                loadHistoryRecords();
                document.querySelector('.tab[data-tab="purchase"]').textContent = 'ÁôºË°åÂç°Áâá';
              }
              break;

            case 'buyer':
              loadMyCardsSecond();
              loadAvailableTradesSecond();
              loadMyTradesSecond();
              loadAvailableCardsMarket();
              loadMyCardsFirst();
              loadAvailableTradesFirst();
              loadMySalesFirst();
              loadHistoryRecords();
              document.querySelector('.tab[data-tab="purchase"]').textContent = 'Ë≥ºË≤∑Âç°Áâá';
              break;
          }
        } catch (error) {
          console.error(`ËºâÂÖ•${role}ËßíËâ≤Êï∏ÊìöÂ§±Êïó:`, error);
        }
      }

      // ËºâÂÖ•ÂèØË≥ºË≤∑Âç°ÁâáÂ∏ÇÂ†¥ - ‰øÆÊîπÁÇ∫Áèæ‰ª£Âç°ÁâáÊ®£Âºè
      async function loadAvailableCardsMarket() {
        const marketDiv = document.getElementById('available-cards-market');

        try {
          marketDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          const availableCards = await contract.getAvailableCards();
          console.log("ÂèØÁî®Âç°Áâá:", availableCards);

          if (availableCards && availableCards.length > 0) {
            let cardsHTML = '';

            for (const card of availableCards) {
              if (card.isSold) continue;

              const shortUID = `${card.uid.slice(0, 10)}...${card.uid.slice(-6)}`;
              const priceEth = ethers.utils.formatEther(card.listPrice);
              const priceWei = card.listPrice.toString();

              cardsHTML += `
              <div class="idol-card">
                <div class="idol-card-image">
                  ${card.photoURI ?
                  `<img src="${card.photoURI}" alt="${card.idolGroup} - ${card.member}" onerror="this.parentElement.innerHTML='<div style=\\'text-align:center; padding:2rem; color:var(--text-secondary)\\'>ÂúñÁâáËºâÂÖ•Â§±Êïó</div>'">` :
                  `<div style="text-align:center; padding:2rem;">ÁÑ°ÂúñÁâá</div>`
                }
                </div>
                <div class="idol-card-content">
                  <div class="idol-card-title">${card.idolGroup} - ${card.member}</div>
                  <div class="idol-card-info">
                    <div>Âç°ÁâáÁ∑®Ëôü: ${card.cardNumber}</div>
                    <div>UID: ${shortUID}</div>
                  </div>
                  <div class="idol-card-price">${priceEth} ETH</div>
                  <div class="idol-card-actions">
                    <button onclick="purchaseSpecificCard('${card.uid}', '${priceWei}')" class="btn-success">Ë≥ºË≤∑</button>
                    <button onclick="viewCardDetails('${card.uid}')">Êü•ÁúãË©≥ÊÉÖ</button>
                  </div>
                </div>
              </div>
            `;
            }

            marketDiv.innerHTML = cardsHTML;
          } else {
            marketDiv.innerHTML = '<p>ÁõÆÂâçÊ≤íÊúâÂèØË≥ºË≤∑ÁöÑÂç°Áâá„ÄÇ</p>';
          }
        } catch (error) {
          console.error("ËºâÂÖ•Â∏ÇÂ†¥Âç°ÁâáÂ§±Êïó:", error);
          marketDiv.innerHTML = `<p class="error">ËºâÂÖ•Â∏ÇÂ†¥Âç°ÁâáÂ§±Êïó: ${error.message}</p>`;
        }
      }

      // ËºâÂÖ•ËΩâÂîÆÂç°ÁâáÂ∏ÇÂ†¥ - ‰øÆÊîπÁÇ∫Áèæ‰ª£Âç°ÁâáÊ®£Âºè
      async function loadResaleCardsMarket() {
        const resaleDiv = document.getElementById('resale-cards-market');

        try {
          resaleDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          const userCards = await contract.getUserCards(userAccount);
          const ownedUIDs = new Set(userCards.map(card => card.uid));

          const resaleCards = await contract.getResaleCards();
          console.log("‰∫åÊâãÂç°Áâá:", resaleCards);

          const filteredResaleCards = resaleCards.filter(card => {
            const cardUid = card[0];
            return !ownedUIDs.has(cardUid);
          });

          if (filteredResaleCards.length > 0) {
            let cardsHTML = '';

            for (const card of filteredResaleCards) {
              const uid = card[0];
              const idolGroup = card[1];
              const member = card[2];
              const cardNumber = card[3];
              const listPrice = card[4];
              const photoURI = card[5];
              const isSold = card[6];

              const priceEth = ethers.utils.formatEther(listPrice.toString());
              const shortUID = `${uid.slice(0, 10)}...${uid.slice(-6)}`;

              cardsHTML += `
              <div class="idol-card">
                <div class="idol-card-image">
                  ${photoURI ?
                  `<img src="${photoURI}" alt="${idolGroup} - ${member}" onerror="this.parentElement.innerHTML='<div style=\\'text-align:center; padding:2rem; color:var(--text-secondary)\\'>ÂúñÁâáËºâÂÖ•Â§±Êïó</div>'">` :
                  `<div style="text-align:center; padding:2rem;">ÁÑ°ÂúñÁâá</div>`
                }
                </div>
                <div class="idol-card-content">
                  <div class="idol-card-title">${idolGroup} - ${member}</div>
                  <div class="idol-card-info">
                    <div>Âç°ÁâáÁ∑®Ëôü: ${cardNumber}</div>
                    <div>UID: ${shortUID}</div>
                    <div style="color: var(--secondary-color); font-weight: 600;">üíé ËΩâÂîÆÂç°Áâá</div>
                  </div>
                  <div class="idol-card-price">${priceEth} ETH</div>
                  <div class="idol-card-actions">
                    <button onclick="buyResaleCard('${uid}', '${listPrice}')" class="btn-secondary">Ë≥ºË≤∑</button>
                    <button onclick="viewCardDetails('${uid}')">Êü•ÁúãË©≥ÊÉÖ</button>
                  </div>
                  <div class="transaction-history">
                    <div class="transaction-item">
                      <span class="transaction-action">üîÑ ËΩâÂîÆ‰∏≠</span>
                      <span class="transaction-amount">${priceEth} ETH</span>
                    </div>
                  </div>
                </div>
              </div>
            `;
            }

            resaleDiv.innerHTML = cardsHTML;
          } else {
            resaleDiv.innerHTML = '<p>ÁõÆÂâçÊ≤íÊúâËΩâÂîÆÁöÑÂç°Áâá„ÄÇ</p>';
          }
        } catch (error) {
          console.error("ËºâÂÖ•‰∫åÊâãÂ∏ÇÂ†¥Âç°ÁâáÂ§±Êïó:", error);
          resaleDiv.innerHTML = `<p class="error">ËºâÂÖ•‰∫åÊâãÂ∏ÇÂ†¥Âç°ÁâáÂ§±Êïó: ${error.message}</p>`;
        }
      }

      async function loadHistoryRecords() {
        try {
          // ÂàùÂßãÂåñ cardManagerContract
          if (!cardManagerContract) {
            const cardManagerAbi = [
              "event CardPurchased(address indexed buyer, uint256 amount, string uid)",
              "event CardApproved(string uid, address indexed buyer, uint256 tokenId)",
              "event CardRequestRejected(string uid, address buyer)"
            ];
            const provider = contract.provider;
            const signer = provider.getSigner(userAccount);
            cardManagerContract = new ethers.Contract(cardManagerAddress, cardManagerAbi, signer);
          }

          let historyDiv;
          if (currentRole === 'company') {
            historyDiv = document.getElementById('history-records-company');
          } else {
            historyDiv = document.getElementById('history-records-buyer');
          }

          if (!historyDiv) {
            console.error('‚ùå Êâæ‰∏çÂà∞ historyDiv ÂÖÉÁ¥†ÔºÅ');
            return;
          }

          console.log("üîç historyDiv ÂèñÂæóÊàêÂäü:", historyDiv);
          historyDiv.style.display = 'block';
          historyDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          const fromBlock = 0; // ÊãâÂÖ®Ê≠∑Âè≤

          let records = [];

          if (currentRole === 'company') {
            // ÂÖ¨Âè∏ÁúãÊâÄÊúâ‰∫ã‰ª∂
            const [purchaseEvents, approveEvents] = await Promise.all([
              cardManagerContract.queryFilter(cardManagerContract.filters.CardPurchased(), fromBlock, 'latest'),
              cardManagerContract.queryFilter(cardManagerContract.filters.CardApproved(), fromBlock, 'latest')
            ]);

            await processCompanyEventsSimple(records, purchaseEvents, approveEvents);

          } else {
            // Áî®Êà∂ÁúãËá™Â∑±Áõ∏ÈóúÁöÑ‰∫ã‰ª∂
            const [allPurchaseEvents, myApproveEvents] = await Promise.all([
              // Áç≤ÂèñÊâÄÊúâË≥ºË≤∑‰∫ã‰ª∂ÔºàÁî®‰æÜÂà§Êñ∑‰∏ÄÊâã/‰∫åÊâãÔºâ
              cardManagerContract.queryFilter(cardManagerContract.filters.CardPurchased(), fromBlock, 'latest'),
              // ÊàëÁöÑÂØ©Êâπ‰∫ã‰ª∂
              cardManagerContract.queryFilter(cardManagerContract.filters.CardApproved(null, userAccount), fromBlock, 'latest')
            ]);

            await processUserEventsSimple(records, allPurchaseEvents, myApproveEvents);
          }

          // ÊåâÊôÇÈñìÊéíÂ∫èÔºàÊúÄÊñ∞ÁöÑÂú®ÂâçÈù¢Ôºâ
          records.sort((a, b) => b.timestamp - a.timestamp);

          displayHistoryRecordsSimple(historyDiv, records);

        } catch (error) {
          console.error("‚ùå ËºâÂÖ•ÈÅéÂæÄÁ¥ÄÈåÑÂ§±Êïó:", error);
          let historyDiv = currentRole === 'company'
            ? document.getElementById('history-records-company')
            : document.getElementById('history-records-buyer');
          if (historyDiv) {
            historyDiv.innerHTML = `
        <div style="text-align: center; padding: 2rem; color: var(--error-color);">
          <div style="font-size: 2rem; margin-bottom: 1rem;">‚ö†Ô∏è</div>
          <h3>ËºâÂÖ•Â§±Êïó</h3>
          <p>ÁÑ°Ê≥ïËºâÂÖ•‰∫§ÊòìÁ¥ÄÈåÑÔºåË´ãÁ®çÂæåÈáçË©¶„ÄÇ</p>
          <details style="margin-top: 1rem; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto;">
            <summary>ÈåØË™§Ë©≥ÊÉÖ</summary>
            <pre style="background: rgba(0,0,0,0.1); padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.8em;">${error.message}</pre>
          </details>
        </div>
      `;
          }
        }
      }

      // ËôïÁêÜÂÖ¨Âè∏‰∫ã‰ª∂ÔºàÁ∞°ÂåñÁâàÔºâ
      async function processCompanyEventsSimple(records, purchaseEvents, approveEvents) {
        // Âª∫Á´ã UID Âà∞Ë≥ºË≤∑Ê≠∑Âè≤ÁöÑÊò†Â∞ÑÔºàÂÖ¨Âè∏Ë¶ñËßíÔºâ
        const uidPurchaseHistory = {};

        // ÂÖàËôïÁêÜÊâÄÊúâË≥ºË≤∑‰∫ã‰ª∂ÔºåÂª∫Á´ãÊØèÂÄã UID ÁöÑË≥ºË≤∑Ê≠∑Âè≤
        for (const event of purchaseEvents) {
          const uid = event.args[2];
          const buyer = event.args[0];
          const blockNumber = event.blockNumber;

          if (!uidPurchaseHistory[uid]) {
            uidPurchaseHistory[uid] = [];
          }

          uidPurchaseHistory[uid].push({
            buyer: buyer,
            blockNumber: blockNumber,
            event: event
          });
        }

        // ÁÇ∫ÊØèÂÄã UID ÊåâÂçÄÂ°äËôüÊéíÂ∫è
        for (const uid in uidPurchaseHistory) {
          uidPurchaseHistory[uid].sort((a, b) => a.blockNumber - b.blockNumber);
        }

        // ËôïÁêÜË≥ºË≤∑‰∫ã‰ª∂
        for (const event of purchaseEvents) {
          try {
            const block = await event.getBlock();
            const uid = event.args[2];
            const buyer = event.args[0];
            const amount = event.args[1];
            const shortUID = `${uid.slice(0, 8)}...${uid.slice(-6)}`;
            const shortBuyer = `${buyer.slice(0, 6)}...${buyer.slice(-4)}`;
            const amountEth = ethers.utils.formatEther(amount);

            // Ê™¢Êü•ÈÄôÊòØÂê¶ÊòØÈÄôÂÄã UID ÁöÑÁ¨¨‰∏ÄÊ¨°Ë≥ºË≤∑
            const purchaseHistory = uidPurchaseHistory[uid] || [];
            const isFirstPurchase = purchaseHistory.length > 0 &&
              purchaseHistory[0].blockNumber === event.blockNumber;

            let sellerInfo = '';
            if (!isFirstPurchase) {
              // Â¶ÇÊûú‰∏çÊòØÁ¨¨‰∏ÄÊ¨°Ë≥ºË≤∑ÔºåÊâæÂá∫Ë≥£ÂÆ∂
              const currentPurchaseIndex = purchaseHistory.findIndex(p => p.blockNumber === event.blockNumber);
              if (currentPurchaseIndex > 0) {
                const previousOwner = purchaseHistory[currentPurchaseIndex - 1].buyer;
                const shortSeller = `${previousOwner.slice(0, 6)}...${previousOwner.slice(-4)}`;
                sellerInfo = `, Ë≥£ÂÆ∂: ${shortSeller}`;
              }
            }

            records.push({
              blockNumber: event.blockNumber,
              timestamp: block.timestamp,
              type: isFirstPurchase ? 'company-primary-sale' : 'company-secondary-sale',
              event: isFirstPurchase ? `üí∞ ‰∏ÄÊâãÈä∑ÂîÆ` : `üîÑ ‰∫åÊâã‰∫§Êòì`,
              details: `UID: ${shortUID}, Ë≤∑ÂÆ∂: ${shortBuyer}, ÈáëÈ°ç: ${amountEth} ETH${sellerInfo}`,
              fullUID: uid,
              fullBuyer: buyer
            });
          } catch (error) {
            console.warn("ËôïÁêÜË≥ºË≤∑‰∫ã‰ª∂Â§±Êïó:", error);
          }
        }

        // ËôïÁêÜÂØ©Êâπ‰∫ã‰ª∂
        for (const event of approveEvents) {
          try {
            const block = await event.getBlock();
            const uid = event.args[0];
            const buyer = event.args[1];
            const tokenId = event.args[2];
            const shortUID = `${uid.slice(0, 8)}...${uid.slice(-6)}`;
            const shortBuyer = `${buyer.slice(0, 6)}...${buyer.slice(-4)}`;

            records.push({
              blockNumber: event.blockNumber,
              timestamp: block.timestamp,
              type: 'approve',
              event: `‚úÖ ÂØ©ÊâπÈÄöÈÅé`,
              details: `UID: ${shortUID}, Ë≤∑ÂÆ∂: ${shortBuyer}, Token ID: ${tokenId}`,
              fullUID: uid,
              fullBuyer: buyer
            });
          } catch (error) {
            console.warn("ËôïÁêÜÂØ©Êâπ‰∫ã‰ª∂Â§±Êïó:", error);
          }
        }
      }

      // ËôïÁêÜÁî®Êà∂‰∫ã‰ª∂ÔºàÁ∞°ÂåñÁâàÔºâ
      async function processUserEventsSimple(records, allPurchaseEvents, approveEvents) {
        // Âª∫Á´ã UID Âà∞Ë≥ºË≤∑Ê≠∑Âè≤ÁöÑÊò†Â∞Ñ
        const uidPurchaseHistory = {};

        // ÂÖàËôïÁêÜÊâÄÊúâË≥ºË≤∑‰∫ã‰ª∂ÔºåÂª∫Á´ãÊØèÂÄã UID ÁöÑË≥ºË≤∑Ê≠∑Âè≤
        for (const event of allPurchaseEvents) {
          const uid = event.args[2];
          const buyer = event.args[0];
          const blockNumber = event.blockNumber;

          if (!uidPurchaseHistory[uid]) {
            uidPurchaseHistory[uid] = [];
          }

          uidPurchaseHistory[uid].push({
            buyer: buyer,
            blockNumber: blockNumber,
            event: event
          });
        }

        // ÁÇ∫ÊØèÂÄã UID ÊåâÂçÄÂ°äËôüÊéíÂ∫è
        for (const uid in uidPurchaseHistory) {
          uidPurchaseHistory[uid].sort((a, b) => a.blockNumber - b.blockNumber);
        }

        // ËôïÁêÜËàáÁï∂ÂâçÁî®Êà∂Áõ∏ÈóúÁöÑË≥ºË≤∑‰∫ã‰ª∂
        for (const event of allPurchaseEvents) {
          const buyer = event.args[0];
          if (buyer.toLowerCase() !== userAccount.toLowerCase()) {
            continue; // Ë∑≥ÈÅé‰∏çÊòØÁï∂ÂâçÁî®Êà∂ÁöÑË≥ºË≤∑
          }

          try {
            const block = await event.getBlock();
            const uid = event.args[2];
            const amount = event.args[1];
            const shortUID = `${uid.slice(0, 8)}...${uid.slice(-6)}`;
            const amountEth = ethers.utils.formatEther(amount);

            // Ê™¢Êü•ÈÄôÊòØÂê¶ÊòØÈÄôÂÄã UID ÁöÑÁ¨¨‰∏ÄÊ¨°Ë≥ºË≤∑
            const purchaseHistory = uidPurchaseHistory[uid] || [];
            const isFirstPurchase = purchaseHistory.length > 0 &&
              purchaseHistory[0].blockNumber === event.blockNumber;

            let eventType, eventText, details;

            if (isFirstPurchase) {
              // Á¨¨‰∏ÄÊ¨°Ë≥ºË≤∑ = ‰∏ÄÊâã‰∫§Êòì
              eventType = 'my-primary-purchase';
              eventText = `üí∞ ‰∏ÄÊâãË≥ºË≤∑`;
              details = `UID: ${shortUID}, ÈáëÈ°ç: ${amountEth} ETH`;
            } else {
              // ÂæåÁ∫åË≥ºË≤∑ = ‰∫åÊâã‰∫§Êòì
              // ÊâæÂá∫Ë≥£ÂÆ∂ÔºàÂâç‰∏ÄÂÄãÊìÅÊúâËÄÖÔºâ
              const myPurchaseIndex = purchaseHistory.findIndex(p => p.blockNumber === event.blockNumber);
              let sellerInfo = '';

              if (myPurchaseIndex > 0) {
                const previousOwner = purchaseHistory[myPurchaseIndex - 1].buyer;
                const shortSeller = `${previousOwner.slice(0, 6)}...${previousOwner.slice(-4)}`;
                sellerInfo = `, Ë≥£ÂÆ∂: ${shortSeller}`;
              }

              eventType = 'my-secondary-purchase';
              eventText = `üõí ‰∫åÊâãË≥ºË≤∑`;
              details = `UID: ${shortUID}, ÈáëÈ°ç: ${amountEth} ETH${sellerInfo}`;
            }

            records.push({
              blockNumber: event.blockNumber,
              timestamp: block.timestamp,
              type: eventType,
              event: eventText,
              details: details,
              fullUID: uid
            });
          } catch (error) {
            console.warn("ËôïÁêÜÊàëÁöÑË≥ºË≤∑‰∫ã‰ª∂Â§±Êïó:", error);
          }
        }

        // ËôïÁêÜÊàë‰ΩúÁÇ∫Ë≥£ÂÆ∂ÁöÑ‰∫§ÊòìÔºàÊü•ÊâæË™∞ÂæûÊàëÈÄôË£°Ë≤∑‰∫ÜÂç°ÁâáÔºâ
        for (const event of allPurchaseEvents) {
          const buyer = event.args[0];
          if (buyer.toLowerCase() === userAccount.toLowerCase()) {
            continue; // Ë∑≥ÈÅéÊàëËá™Â∑±ÁöÑË≥ºË≤∑
          }

          try {
            const uid = event.args[2];
            const purchaseHistory = uidPurchaseHistory[uid] || [];

            // ÊâæÂá∫ÈÄôÊ¨°Ë≥ºË≤∑ÂâçÁöÑ‰∏ä‰∏ÄÂÄãË≥ºË≤∑ËÄÖÊòØÂê¶ÊòØÊàë
            const buyerPurchaseIndex = purchaseHistory.findIndex(p => p.blockNumber === event.blockNumber);

            if (buyerPurchaseIndex > 0) {
              const previousOwner = purchaseHistory[buyerPurchaseIndex - 1].buyer;

              if (previousOwner.toLowerCase() === userAccount.toLowerCase()) {
                // ÊàëÊòØË≥£ÂÆ∂ÔºÅ
                const block = await event.getBlock();
                const amount = event.args[1];
                const shortUID = `${uid.slice(0, 8)}...${uid.slice(-6)}`;
                const shortBuyer = `${buyer.slice(0, 6)}...${buyer.slice(-4)}`;
                const amountEth = ethers.utils.formatEther(amount);

                records.push({
                  blockNumber: event.blockNumber,
                  timestamp: block.timestamp,
                  type: 'my-sale',
                  event: `üí∏ Âç°ÁâáË≤©ÂîÆ`,
                  details: `UID: ${shortUID}, Ë≤∑ÂÆ∂: ${shortBuyer}, ÈáëÈ°ç: ${amountEth} ETH`,
                  fullUID: uid,
                  fullBuyer: buyer
                });
              }
            }
          } catch (error) {
            console.warn("ËôïÁêÜÊàëÁöÑË≤©ÂîÆ‰∫ã‰ª∂Â§±Êïó:", error);
          }
        }

        // ËôïÁêÜÂØ©Êâπ‰∫ã‰ª∂
        for (const event of approveEvents) {
          try {
            const block = await event.getBlock();
            const uid = event.args[0];
            const tokenId = event.args[2];
            const shortUID = `${uid.slice(0, 8)}...${uid.slice(-6)}`;

            records.push({
              blockNumber: event.blockNumber,
              timestamp: block.timestamp,
              type: 'my-approve',
              event: `‚úÖ ÂØ©ÊâπÈÄöÈÅé`,
              details: `UID: ${shortUID}, Token ID: ${tokenId}`,
              fullUID: uid
            });
          } catch (error) {
            console.warn("ËôïÁêÜÊàëÁöÑÂØ©Êâπ‰∫ã‰ª∂Â§±Êïó:", error);
          }
        }
      }

      // Ê™¢Êü•ÊòØÂê¶ÁÇ∫È¶ñÊ¨°Ë≥ºË≤∑
      async function isFirstTimePurchase(uid, currentBlockNumber) {
        try {
          const purchaseFilter = cardManagerContract.filters.CardPurchased(null, null, uid);
          const purchaseEvents = await cardManagerContract.queryFilter(purchaseFilter, 0, 'latest');

          // ÊâæÂá∫ÊúÄÊó©ÁöÑË≥ºË≤∑‰∫ã‰ª∂
          if (purchaseEvents.length === 0) return true;

          const earliestPurchase = purchaseEvents.reduce((earliest, current) => {
            return current.blockNumber < earliest.blockNumber ? current : earliest;
          });

          return earliestPurchase.blockNumber === currentBlockNumber;
        } catch (error) {
          console.warn("Ê™¢Êü•È¶ñÊ¨°Ë≥ºË≤∑Â§±Êïó:", error);
          return true; // È†êË®≠ÁÇ∫È¶ñÊ¨°Ë≥ºË≤∑
        }
      }

      // È°ØÁ§∫Ê≠∑Âè≤Ë®òÈåÑÔºàÁ∞°ÂåñÁâàÔºâ
      function displayHistoryRecordsSimple(historyDiv, records) {
        if (records.length > 0) {
          console.log("üìö records length", records.length);

          let html = '<div style="overflow-x: auto;"><table class="modern-table">';
          html += '<thead><tr><th>ÊôÇÈñì</th><th>ÂçÄÂ°äËôü</th><th>‰∫ã‰ª∂È°ûÂûã</th><th>Ë©≥Á¥∞Ë≥áË®ä</th></tr></thead><tbody>';

          for (const record of records) {
            const date = new Date(record.timestamp * 1000).toLocaleString('zh-TW');
            let typeClass = '';

            switch (record.type) {
              case 'company-primary-sale':
              case 'my-primary-purchase':
                typeClass = 'status-completed';
                break;
              case 'approve':
              case 'my-approve':
                typeClass = 'status-buyer-signed';
                break;
              case 'my-sale':
                typeClass = 'status-seller-signed';
                break;
              case 'my-secondary-purchase':
              case 'company-secondary-sale':
                typeClass = 'status-created';
                break;
              default:
                typeClass = 'status-created';
            }

            html += `
        <tr>
          <td style="min-width: 140px;">${date}</td>
          <td style="font-family: monospace;">#${record.blockNumber}</td>
          <td><span class="trade-status ${typeClass}">${record.event}</span></td>
          <td style="font-size: 0.9em;" title="${record.details}">${record.details}</td>
        </tr>
      `;
          }

          html += '</tbody></table></div>';

          // Áµ±Ë®àË≥áË®ä
          const primaryPurchaseCount = records.filter(r => r.type === 'company-primary-sale' || r.type === 'my-primary-purchase').length;
          const secondaryPurchaseCount = records.filter(r => r.type === 'my-secondary-purchase' || r.type === 'company-secondary-sale').length;
          const saleCount = records.filter(r => r.type === 'my-sale').length;
          const approveCount = records.filter(r => r.type === 'approve' || r.type === 'my-approve').length;

          html += `
      <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(236, 72, 153, 0.05); border-radius: 12px; border-left: 4px solid var(--primary-color);">
        <h4 style="margin-bottom: 0.5rem; color: var(--primary-color);">Áµ±Ë®àÊëòË¶Å</h4>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1rem; font-size: 0.9rem;">
          <div>üí∞ ‰∏ÄÊâã‰∫§Êòì: <strong>${primaryPurchaseCount}</strong></div>
          <div>üõí ‰∫åÊâã‰∫§Êòì: <strong>${secondaryPurchaseCount}</strong></div>
          <div>üí∏ Ë≤©ÂîÆÊ¨°Êï∏: <strong>${saleCount}</strong></div>
          <div>‚úÖ ÂØ©ÊâπÈÄöÈÅé: <strong>${approveCount}</strong></div>
          <div>üìå Á∏ΩË®àÁ¥ÄÈåÑ: <strong>${records.length}</strong></div>
        </div>
      </div>
    `;

          historyDiv.innerHTML = html;
          console.log('‚úÖ Â∑≤ÊàêÂäüËºâÂÖ•‰∫§ÊòìÁ¥ÄÈåÑ');
        } else {
          historyDiv.innerHTML = `
      <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
        <div style="font-size: 2rem; margin-bottom: 1rem;">üì≠</div>
        <h3>ÁõÆÂâçÊ≤íÊúâ‰∫§ÊòìÁ¥ÄÈåÑ</h3>
        <p>Áï∂ÊÇ®ÈñãÂßã‰ΩøÁî®Á≥ªÁµ±ÂæåÔºå‰∫§ÊòìË®òÈåÑÊúÉÂá∫ÁèæÂú®ÈÄôË£°„ÄÇ</p>
      </div>
    `;
          console.log('‚ö†Ô∏è Ê≤íÊúâ‰ªª‰ΩïÊ≠∑Âè≤Á¥ÄÈåÑ');
        }
      }
      // ËºâÂÖ•ÊàëÁöÑÂç°Áâá - ‰øÆÊîπÁÇ∫Áèæ‰ª£Âç°ÁâáÊ®£Âºè
      async function loadMyCardsFirst() {
        try {
          const myCardsDiv = document.getElementById('my-cards-list-first');
          myCardsDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          const userCards = await contract.getUserCards(userAccount);
          const resaleCards = await contract.getResaleCards();
          const resaleUIDs = new Set(resaleCards.map(card => card[0]));

          const unsoldUserCards = userCards.filter(card => !resaleUIDs.has(card.uid));

          if (unsoldUserCards.length > 0) {
            let cardsHTML = '';

            for (const card of unsoldUserCards) {
              const shortUID = `${card.uid.slice(0, 10)}...${card.uid.slice(-6)}`;
              const priceEth = ethers.utils.formatEther(card.listPrice);

              cardsHTML += `
              <div class="idol-card">
                <div class="idol-card-image">
                  ${card.photoURI ?
                  `<img src="${card.photoURI}" alt="${card.idolGroup} - ${card.member}" onerror="this.parentElement.innerHTML='<div style=\\'text-align:center; padding:2rem; color:var(--text-secondary)\\'>ÂúñÁâáËºâÂÖ•Â§±Êïó</div>'">` :
                  `<div style="text-align:center; padding:2rem;">ÁÑ°ÂúñÁâá</div>`
                }
                </div>
                <div class="idol-card-content">
                  <div class="idol-card-title">${card.idolGroup} - ${card.member}</div>
                  <div class="idol-card-info">
                    <div>Âç°ÁâáÁ∑®Ëôü: ${card.cardNumber}</div>
                    <div>UID: ${shortUID}</div>
                    <div style="color: var(--success-color); font-weight: 600;">‚úÖ Â∑≤ÊìÅÊúâ</div>
                  </div>
                  <div class="idol-card-price">ÂéüÂÉπ ${priceEth} ETH</div>
                  <div class="idol-card-actions">
                    <button onclick="viewCardDetails('${card.uid}')">Êü•ÁúãË©≥ÊÉÖ</button>
                  </div>
                </div>
              </div>
            `;
            }

            myCardsDiv.innerHTML = cardsHTML;
          } else {
            myCardsDiv.innerHTML = '<p>ÊÇ®ÈÇÑÊ≤íÊúâ‰ªª‰ΩïÊú™‰∏äÊû∂ÁöÑÂç°Áâá„ÄÇ</p>';
          }
        } catch (error) {
          console.error("ËºâÂÖ•Á¨¨‰∏ÄÊâãË≤∑ÂÆ∂Âç°ÁâáÂ§±Êïó:", error);
          document.getElementById('my-cards-list-first').innerHTML = '<p class="error">ËºâÂÖ•Âç°ÁâáÂ§±Êïó„ÄÇ</p>';
        }
      }

      // ËºâÂÖ•ÊàëÁöÑ‰∏äÊû∂Âç°Áâá - ‰øÆÊîπÁÇ∫Áèæ‰ª£Âç°ÁâáÊ®£Âºè
      async function loadMyCardsSecond() {
        try {
          const myCardsDiv = document.getElementById('my-cards-list-second');
          const cardToSell = document.getElementById('card-to-sell');

          myCardsDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          // 1. ËºâÂÖ•Ëá™Â∑±ÊìÅÊúâÁöÑ NFT
          const userCards = await contract.getUserCards(userAccount);
          // 2. ËºâÂÖ•Â∑≤‰∏äÊû∂ÁöÑ UID
          const resaleCards = await contract.getResaleCards();
          const resaleUIDs = new Set(resaleCards.map(c => c.uid));

          // È°ØÁ§∫Â∑≤‰∏äÊû∂ÁöÑÂç°Áâá
          const listed = userCards.filter(c => resaleUIDs.has(c.uid));
          let cardsHTML='';
          if (listed.length) {
            for (const card of listed) {
              const shortUID = `${card.uid.slice(0, 10)}...${card.uid.slice(-6)}`;
              const priceEth = ethers.utils.formatEther(card.listPrice);
              
              cardsHTML += `
              <div class="idol-card">
                <div class="idol-card-image">
                  ${card.photoURI ?
                  `<img src="${card.photoURI}" alt="${card.idolGroup} - ${card.member}" onerror="this.parentElement.innerHTML='<div style=\\'text-align:center; padding:2rem; color:var(--text-secondary)\\'>ÂúñÁâáËºâÂÖ•Â§±Êïó</div>'">` :
                  `<div style="text-align:center; padding:2rem;">ÁÑ°ÂúñÁâá</div>`
                }
                </div>
                <div class="idol-card-content">
                  <div class="idol-card-title">${card.idolGroup} - ${card.member}</div>
                  <div class="idol-card-info">
                    <div>Âç°ÁâáÁ∑®Ëôü: ${card.cardNumber}</div>
                    <div>UID: ${shortUID}</div>
                    <div style="color: var(--warning-color); font-weight: 600;">‰∏äÊû∂‰∏≠</div>
                  </div>
                  <div class="idol-card-price">${priceEth} ETH</div>
                  <div class="idol-card-actions">
                    <button onclick="cancelResaleCard('${card.uid}')">ÂèñÊ∂à‰∏äÊû∂</button>
                  </div>
                </div>
              </div>
            `;
            }

            myCardsDiv.innerHTML = cardsHTML;
          } else {
            myCardsDiv.innerHTML = '<p>ÁõÆÂâçÊ≤íÊúâÊÇ®‰∏äÊû∂‰∏≠ÁöÑÂç°Áâá„ÄÇ</p>';
          }

          // Â∞áÊú™‰∏äÊû∂Âç°ÁâáÂä†Âà∞‰∏ãÊãâÈÅ∏ÂñÆ
          // Ê∏ÖÁ©∫‰∏ãÊãâÈÅ∏ÂñÆ
          while (cardToSell.options.length > 1) cardToSell.remove(1);
          const unlisted = userCards.filter(c => !resaleUIDs.has(c.uid));
          for (const c of unlisted) {
            const opt = document.createElement('option');
            opt.value = c.uid;
            opt.textContent = `${c.idolGroup} - ${c.member} (#${c.cardNumber})`;
            cardToSell.appendChild(opt);
          }
        } catch (error) {
          console.error("ËºâÂÖ•Á¨¨‰∫åÊâãË≥£ÂÆ∂Âç°ÁâáÂ§±Êïó:", error);
          document.getElementById('my-cards-list-second').innerHTML = '<p class="error">ËºâÂÖ•Âç°ÁâáÂ§±Êïó„ÄÇ</p>';
        }
      }

      // ËºâÂÖ•Âç°ÁâáÁµ±Ë®à - ‰ΩøÁî®Áèæ‰ª£Ë°®Ê†ºÊ®£Âºè
      async function loadCardStats() {
        try {
          const statsDiv = document.getElementById('card-stats');
          statsDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          const cards = await contract.getCompanyCards();

          if (cards && cards.length > 0) {
            let html = '<table class="modern-table">';
            html += '<thead><tr><th>UID</th><th>ÂúòÈ´î</th><th>ÊàêÂì°</th><th>Âç°Ëôü</th><th>ÂÉπÊ†º (ETH)</th><th>ÁãÄÊÖã</th></tr></thead><tbody>';

            for (const card of cards) {
              const shortUID = `${card.uid.slice(0, 10)}...${card.uid.slice(-6)}`;
              const priceEth = ethers.utils.formatEther(card.listPrice);
              const soldText = card.isSold ?
                '<span class="trade-status status-completed">‚úîÔ∏è Â∑≤ÂîÆÂá∫</span>' :
                '<span class="trade-status status-created">‚ùå Â∞öÊú™ÂîÆÂá∫</span>';

              html += `
              <tr>
                <td title="${card.uid}">${shortUID}</td>
                <td>${card.idolGroup}</td>
                <td>${card.member}</td>
                <td>${card.cardNumber}</td>
                <td>${priceEth}</td>
                <td>${soldText}</td>
              </tr>
            `;
            }

            html += '</tbody></table>';
            statsDiv.innerHTML = html;
          } else {
            statsDiv.innerHTML = '<p>ÁõÆÂâçÂ∞öÊú™ÁôºË°å‰ªª‰ΩïÂç°Áâá„ÄÇ</p>';
          }
        } catch (error) {
          console.error("ËºâÂÖ•ÂÖ¨Âè∏Âç°ÁâáÁµ±Ë®àÂ§±Êïó:", error);
          document.getElementById('card-stats').innerHTML = '<p class="error">ËºâÂÖ•Âç°ÁâáË≥áË®äÂ§±Êïó„ÄÇ</p>';
        }
      }

      // ËºâÂÖ•ÂæÖÂØ©ÊâπË´ãÊ±Ç - ‰ΩøÁî®Áèæ‰ª£Ë°®Ê†ºÊ®£Âºè
      async function loadPendingRequests() {
        if (!isOwner) {
          document.getElementById('pending-requests').innerHTML = '<p>Âè™ÊúâÂêàÁ¥ÑÊìÅÊúâËÄÖÂèØÊü•ÁúãÂæÖËôïÁêÜË´ãÊ±Ç„ÄÇ</p>';
          return;
        }

        try {
          const pendingDiv = document.getElementById('pending-requests');
          pendingDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          const pendingRequests = await contract.getPendingCardRequests();

          if (pendingRequests && pendingRequests.length > 0) {
            let requestsHTML = '<table class="modern-table">';
            requestsHTML += '<thead><tr><th>Âç°ÁâáUID</th><th>Ë≤∑ÂÆ∂Âú∞ÂùÄ</th><th>ÈáëÈ°ç</th><th>Ë´ãÊ±ÇÊôÇÈñì</th><th>Êìç‰Ωú</th></tr></thead><tbody>';

            for (const request of pendingRequests) {
              const shortUID = `${request.uid.slice(0, 10)}...${request.uid.slice(-6)}`;
              const date = new Date(request.timestamp * 1000);
              const formattedDate = date.toLocaleString();
              const amount = ethers.utils.formatEther(request.amount);

              requestsHTML += `
              <tr>
                <td title="${request.uid}">${shortUID}</td>
                <td>${request.buyer}</td>
                <td>${amount} ETH</td>
                <td>${formattedDate}</td>
                <td>
                  <button onclick="approveTransfer('${request.uid}')" class="btn-success" style="margin-right: 0.5rem;">ÊâπÂáÜ</button>
                  <button onclick="rejectTransfer('${request.uid}')" class="btn-danger">ÊãíÁµï</button>
                </td>
              </tr>
            `;
            }

            requestsHTML += '</tbody></table>';
            pendingDiv.innerHTML = requestsHTML;
          } else {
            pendingDiv.innerHTML = '<p>ÁõÆÂâçÊ≤íÊúâÂæÖËôïÁêÜÁöÑË´ãÊ±Ç„ÄÇ</p>';
          }
        } catch (error) {
          console.error("ËºâÂÖ•ÂæÖËôïÁêÜË´ãÊ±ÇÂ§±Êïó:", error);
          document.getElementById('pending-requests').innerHTML = `<p class="error">ËºâÂÖ•ÂæÖËôïÁêÜË´ãÊ±ÇÂ§±Êïó: ${error.message}</p>`;
        }
      }

      // ËºâÂÖ•ÂèØÁî®‰∫§Êòì - ‰ΩøÁî®Áèæ‰ª£Ë°®Ê†ºÊ®£Âºè
      async function loadAvailableTradesFirst() {
        try {
          const tradesDiv = document.getElementById('available-trades-first');
          tradesDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          const trades = await contract.getAvailableTrades();

          if (trades && trades.length > 0) {
            let tradesHTML = '<table class="modern-table">';
            tradesHTML += '<thead><tr><th>‰∫§ÊòìID</th><th>Âç°ÁâáID</th><th>Ë≥£ÂÆ∂</th><th>ÂÉπÊ†º</th><th>Êìç‰Ωú</th></tr></thead><tbody>';

            for (const trade of trades) {
              tradesHTML += `
              <tr>
                <td>#${trade.tradeId}</td>
                <td>#${trade.tokenId}</td>
                <td>${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}</td>
                <td>${ethers.utils.formatEther(trade.price)} ETH</td>
                <td>
                  <button onclick="buyCard(${trade.tradeId}, '${trade.price}')" class="btn-success">Ë≥ºË≤∑</button>
                </td>
              </tr>
            `;
            }

            tradesHTML += '</tbody></table>';
            tradesDiv.innerHTML = tradesHTML;
          } else {
            tradesDiv.innerHTML = '<p>ÁõÆÂâçÊ≤íÊúâÂèØÁî®ÁöÑ‰∫§Êòì„ÄÇ</p>';
          }
        } catch (error) {
          console.error("ËºâÂÖ•Á¨¨‰∏ÄÊâãË≤∑ÂÆ∂ÂèØÁî®‰∫§ÊòìÂ§±Êïó:", error);
          document.getElementById('available-trades-first').innerHTML = '<p class="error">ËºâÂÖ•‰∫§ÊòìÂ§±Êïó„ÄÇ</p>';
        }
      }

      // ËºâÂÖ•ÊàëÁöÑÈä∑ÂîÆ - ‰ΩøÁî®Áèæ‰ª£Ë°®Ê†ºÊ®£Âºè
      async function loadMySalesFirst() {
        try {
          const salesDiv = document.getElementById('my-sales-first');
          salesDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          const trades = await contract.getUserTrades(userAccount);

          if (trades && trades.length > 0) {
            const sales = trades.filter(trade => trade.seller.toLowerCase() === userAccount.toLowerCase());

            if (sales.length > 0) {
              let salesHTML = '<table class="modern-table">';
              salesHTML += '<thead><tr><th>‰∫§ÊòìID</th><th>Âç°ÁâáID</th><th>Ë≤∑ÂÆ∂</th><th>ÂÉπÊ†º</th><th>ÁãÄÊÖã</th><th>Êìç‰Ωú</th></tr></thead><tbody>';

              for (const sale of sales) {
                let statusText = '';
                let actionButton = '';

                switch (sale.status) {
                  case 0:
                    statusText = '<span class="trade-status status-created">Â∑≤ÂâµÂª∫</span>';
                    break;
                  case 1:
                    statusText = '<span class="trade-status status-buyer-signed">Ë≤∑ÂÆ∂Â∑≤Á∞ΩÁΩ≤</span>';
                    actionButton = `<button onclick="sellerSign(${sale.tradeId})" class="btn-success">Á∞ΩÁΩ≤‰∫§Êòì</button>`;
                    break;
                  case 2:
                    statusText = '<span class="trade-status status-seller-signed">Ë≥£ÂÆ∂Â∑≤Á∞ΩÁΩ≤</span>';
                    break;
                  case 5:
                    statusText = '<span class="trade-status status-completed">Â∑≤ÂÆåÊàê</span>';
                    break;
                  default:
                    statusText = `<span class="trade-status">ÁãÄÊÖã: ${sale.status}</span>`;
                }

                salesHTML += `
                <tr>
                  <td>#${sale.tradeId}</td>
                  <td>#${sale.tokenId}</td>
                  <td>${sale.buyer ? `${sale.buyer.slice(0, 6)}...${sale.buyer.slice(-4)}` : 'Êú™ÂÆö'}</td>
                  <td>${ethers.utils.formatEther(sale.price)} ETH</td>
                  <td>${statusText}</td>
                  <td>${actionButton}</td>
                </tr>
              `;
              }

              salesHTML += '</tbody></table>';
              salesDiv.innerHTML = salesHTML;
            } else {
              salesDiv.innerHTML = '<p>ÊÇ®Ê≤íÊúâ‰ªª‰ΩïÈä∑ÂîÆË®òÈåÑ„ÄÇ</p>';
            }
          } else {
            salesDiv.innerHTML = '<p>ÊÇ®Ê≤íÊúâ‰ªª‰ΩïÈä∑ÂîÆË®òÈåÑ„ÄÇ</p>';
          }
        } catch (error) {
          console.error("ËºâÂÖ•Á¨¨‰∏ÄÊâãË≤∑ÂÆ∂Èä∑ÂîÆÂ§±Êïó:", error);
          document.getElementById('my-sales-first').innerHTML = '<p class="error">ËºâÂÖ•Èä∑ÂîÆË®òÈåÑÂ§±Êïó„ÄÇ</p>';
        }
      }

      // ËºâÂÖ•Á¨¨‰∫åÊâãË≤∑ÂÆ∂/Ë≥£ÂÆ∂ÂèØÁî®‰∫§Êòì
      async function loadAvailableTradesSecond() {
        try {
          const tradesDiv = document.getElementById('available-trades-second');
          tradesDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          const trades = await contract.getAvailableTrades();

          if (trades && trades.length > 0) {
            let tradesHTML = '<table class="modern-table">';
            tradesHTML += '<thead><tr><th>‰∫§ÊòìID</th><th>Âç°ÁâáID</th><th>Ë≥£ÂÆ∂</th><th>ÂÉπÊ†º</th><th>Êìç‰Ωú</th></tr></thead><tbody>';

            for (const trade of trades) {
              tradesHTML += `
              <tr>
                <td>#${trade.tradeId}</td>
                <td>#${trade.tokenId}</td>
                <td>${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}</td>
                <td>${ethers.utils.formatEther(trade.price)} ETH</td>
                <td>
                  <button onclick="buyCard(${trade.tradeId}, '${trade.price}')" class="btn-success">Ë≥ºË≤∑</button>
                </td>
              </tr>
            `;
            }

            tradesHTML += '</tbody></table>';
            tradesDiv.innerHTML = tradesHTML;
          } else {
            tradesDiv.innerHTML = '<p>ÁõÆÂâçÊ≤íÊúâÂèØÁî®ÁöÑ‰∫§Êòì„ÄÇ</p>';
          }
        } catch (error) {
          console.error("ËºâÂÖ•Á¨¨‰∫åÊâãË≤∑ÂÆ∂/Ë≥£ÂÆ∂ÂèØÁî®‰∫§ÊòìÂ§±Êïó:", error);
          document.getElementById('available-trades-second').innerHTML = '<p class="error">ËºâÂÖ•‰∫§ÊòìÂ§±Êïó„ÄÇ</p>';
        }
      }
      async function fetchResaleStatus(uid) {
        const resaleCards = await contract.getResaleCards();
        // getResaleCards ÂõûÂÇ≥ CardDisplay[]Ôºåuid Âú®ÊØèÂÄãÂÖÉÁ¥†ÁöÑ .uid ‰∏ä
        return resaleCards.some(c => c.uid === uid);
      }

      window.cancelResaleCard = async function cancelResaleCard(uid) {
        console.log("‰Ω†Â∞á cancel ÁöÑ uid=", uid);
        const resaleCards = await contract.getResaleCards();
        console.log("ÊâÄÊúâ‰∏äÊû∂UID", resaleCards.map(c => c.uid));
        if (!confirm(`Á¢∫ÂÆöË¶ÅÂèñÊ∂à‰∏äÊû∂Âç°Áâá ${uid}... ÂóéÔºü`)) return;
        console.log(`„Äê${uid}„ÄëÂèñÊ∂àÂâç:`, await fetchResaleStatus(uid)); 

        try {
          const tx = await contract.cancelResale(uid);
          await tx.wait(); // Á≠âÂæÖ‰∫§ÊòìÂÆåÊàê
          
          console.log(`„Äê${uid}„ÄëÂèñÊ∂àÂæå:`, await fetchResaleStatus(uid)); // false
          alert('Âç°ÁâáÂèñÊ∂à‰∏äÊû∂ÊàêÂäü');
          loadMyCardsSecond(); // ÈáçÊñ∞ËºâÂÖ• UI
        } catch (err) {
          console.error('ÂèñÊ∂à‰∏äÊû∂Â§±Êïó:', err);
          alert('ÂèñÊ∂à‰∏äÊû∂Â§±ÊïóÔºåË´ãÊü•Áúã console log');
        }
      }
      // ËºâÂÖ•ÊàëÁöÑ‰∫§ÊòìÁÆ°ÁêÜ - ‰ΩøÁî®Áèæ‰ª£Ë°®Ê†ºÊ®£Âºè
      async function loadMyTradesSecond() {
        try {
          const tradesDiv = document.getElementById('my-trades-second');
          tradesDiv.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

          const trades = await contract.getUserTrades(userAccount);

          if (trades && trades.length > 0) {
            let tradesHTML = '<table class="modern-table">';
            tradesHTML += '<thead><tr><th>‰∫§ÊòìID</th><th>Âç°ÁâáID</th><th>ËßíËâ≤</th><th>‰∫§ÊòìÂ∞çË±°</th><th>ÂÉπÊ†º</th><th>ÁãÄÊÖã</th><th>Êìç‰Ωú</th></tr></thead><tbody>';

            for (const trade of trades) {
              let roleText = '';
              let counterparty = '';
              let actionButton = '';
              let statusText = '';

              if (trade.seller.toLowerCase() === userAccount.toLowerCase()) {
                roleText = 'Ë≥£ÂÆ∂';
                counterparty = trade.buyer ? `${trade.buyer.slice(0, 6)}...${trade.buyer.slice(-4)}` : 'Êú™ÂÆö';

                if (trade.status === 1) {
                  actionButton = `<button onclick="sellerSign(${trade.tradeId})" class="btn-success">Á∞ΩÁΩ≤‰∫§Êòì</button>`;
                }
              } else {
                roleText = 'Ë≤∑ÂÆ∂';
                counterparty = `${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}`;

                if (trade.status === 2) {
                  actionButton = `<button onclick="finalize(${trade.tradeId})" class="btn-success">ÂÆåÊàê‰∫§Êòì</button>`;
                }
              }

              switch (trade.status) {
                case 0:
                  statusText = '<span class="trade-status status-created">Â∑≤ÂâµÂª∫</span>';
                  break;
                case 1:
                  statusText = '<span class="trade-status status-buyer-signed">Ë≤∑ÂÆ∂Â∑≤Á∞ΩÁΩ≤</span>';
                  break;
                case 2:
                  statusText = '<span class="trade-status status-seller-signed">Ë≥£ÂÆ∂Â∑≤Á∞ΩÁΩ≤</span>';
                  break;
                case 5:
                  statusText = '<span class="trade-status status-completed">Â∑≤ÂÆåÊàê</span>';
                  break;
                default:
                  statusText = `<span class="trade-status">ÁãÄÊÖã: ${trade.status}</span>`;
              }

              tradesHTML += `
              <tr>
                <td>#${trade.tradeId}</td>
                <td>#${trade.tokenId}</td>
                <td>${roleText}</td>
                <td>${counterparty}</td>
                <td>${ethers.utils.formatEther(trade.price)} ETH</td>
                <td>${statusText}</td>
                <td>${actionButton}</td>
              </tr>
            `;
            }

            tradesHTML += '</tbody></table>';
            tradesDiv.innerHTML = tradesHTML;
          } else {
            tradesDiv.innerHTML = '<p>ÊÇ®Ê≤íÊúâ‰ªª‰Ωï‰∫§ÊòìË®òÈåÑ„ÄÇ</p>';
          }
        } catch (error) {
          console.error("ËºâÂÖ•Á¨¨‰∫åÊâãË≤∑ÂÆ∂/Ë≥£ÂÆ∂‰∫§ÊòìÁÆ°ÁêÜÂ§±Êïó:", error);
          document.getElementById('my-trades-second').innerHTML = '<p class="error">ËºâÂÖ•‰∫§ÊòìÁÆ°ÁêÜÂ§±Êïó„ÄÇ</p>';
        }
      }

      // ËºâÂÖ•ÊâÄÊúâ‰∫§ÊòìÊ¶ÇË¶Ω
      async function loadAllTradesOverview() {
        const overviewDiv = document.getElementById('all-trades-overview');
        if (!contract) {
          overviewDiv.innerHTML = '<p>Â∞öÊú™ÈÄ£Êé•ÂêàÁ¥Ñ„ÄÇ</p>';
          return;
        }
        if (!isOwner) {
          overviewDiv.innerHTML = '<p>Âè™ÊúâÂêàÁ¥ÑÊìÅÊúâËÄÖÂèØÊü•Áúã‰∫§ÊòìÊ¶ÇË¶Ω„ÄÇ</p>';
          return;
        }

        try {
          overviewDiv.innerHTML = '<p>Â∑≤ÈÄ£Êé•ÂêàÁ¥ÑÂæÖÂêà‰ΩµÁ®ãÂºè</p>';
        } catch (error) {
          console.error("ËºâÂÖ•‰∫§ÊòìÊ¶ÇË¶ΩÂ§±Êïó:", error);
          overviewDiv.innerHTML = '<p class="error">ËºâÂÖ•‰∫§ÊòìÂ§±Êïó„ÄÇ</p>';
        }
      }

      // ËºâÂÖ•‰∫§ÊòìÊï∏ÊìöÂàÜÊûê
      async function loadTradeAnalytics() {
        const analyticsDiv = document.getElementById('trade-analytics');
        if (!contract) {
          analyticsDiv.innerHTML = '<p>Â∞öÊú™ÈÄ£Êé•ÂêàÁ¥Ñ„ÄÇ</p>';
          return;
        }
        if (!isOwner) {
          analyticsDiv.innerHTML = '<p>Âè™ÊúâÂêàÁ¥ÑÊìÅÊúâËÄÖÂèØ‰ª•Êü•Áúã‰∫§ÊòìÊï∏ÊìöÂàÜÊûê„ÄÇ</p>';
          return;
        }
        try {
          analyticsDiv.innerHTML = '<p>Â∑≤ÈÄ£Êé•ÂêàÁ¥ÑÂæÖÂêà‰ΩµÁ®ãÂºè</p>';
        } catch (error) {
          console.error("ËºâÂÖ•‰∫§ÊòìÊï∏ÊìöÂàÜÊûêÂ§±Êïó:", error);
          analyticsDiv.innerHTML = '<p class="error">ËºâÂÖ•‰∫§ÊòìÊï∏ÊìöÂàÜÊûêÂ§±Êïó„ÄÇ</p>';
        }
      }

      // Â∞áÊìç‰ΩúÂáΩÊï∏ÊéõÂà∞windowÂ∞çË±°‰∏ä
      window.purchaseSpecificCard = purchaseSpecificCard;
      window.approveTransfer = approveTransfer;
      window.buyCard = buyCard;
      window.sellerSign = sellerSign;
      window.finalize = finalize;
      window.buyResaleCard = buyResaleCard;
      window.viewCardDetails = viewCardDetails;

      // Ë®≠ÁΩÆ‰∫ã‰ª∂Áõ£ËÅΩÂô®
      function setupEventListeners() {
        if (!contract) return;

        contract.on("CardPurchased", (buyer, amount, uid) => {
          console.log("ÊçïÁç≤Âà∞ CardPurchased ‰∫ã‰ª∂:", buyer, amount.toString(), uid);

          if (buyer.toLowerCase() === userAccount.toLowerCase()) {
            console.log("Áî®Êà∂Ë≥ºË≤∑Âç°ÁâáÔºåUID:", uid);
            const purchaseStatus = document.getElementById('purchase-status');
            if (purchaseStatus) {
              purchaseStatus.innerHTML = `
              <div class="status success">
                <p>Ë≥ºË≤∑ÊàêÂäüÔºÅ</p>
                <p>Ë´ã‰ΩøÁî®ÊéÉÊèèÂô®ÊéÉÊèèÊÇ®ÁöÑÂç°Áâá UIDÔºåÊàñÊâãÂãïËº∏ÂÖ•„ÄÇ</p>
                <p>Êåâ‰∏ã„ÄåÁ∂ÅÂÆöÂç°Áâá„ÄçÊåâÈàï‰æÜÁî≥Ë´ãÂç°ÁâáÊâÄÊúâÊ¨äËΩâÁßª„ÄÇ</p>
              </div>
            `;
            }

            const uidInput = document.getElementById('card-uid');
            if (uidInput) uidInput.value = uid;
            loadAvailableCardsMarket();
          }
        });
      }

      // Ë≥ºË≤∑ÁâπÂÆöÂç°Áâá
      async function purchaseSpecificCard(uid, priceWei) {
        const purchaseStatus = document.getElementById('purchase-status');
        try {
          purchaseStatus.innerHTML = '<span>ËôïÁêÜ‰∏≠... <div class="loader"></div></span>';
          purchaseStatus.className = 'status info';

          console.log("Ê∫ñÂÇôË≥ºË≤∑Âç°Áâá:", uid);
          console.log("ÂÉπÊ†º(Wei):", priceWei);

          // Ê∏ÖÁêÜÂíåÈ©óË≠â UID - ÁßªÈô§ÂèØËÉΩÁöÑÁâπÊÆäÂ≠óÁ¨¶
          // const cleanUID = uid.trim();

          let valueForTx;
          try {
            valueForTx = ethers.BigNumber.from(priceWei);
          } catch (e) {
            purchaseStatus.innerHTML = `<div class="status error">ÂÉπÊ†ºÊ†ºÂºèÈåØË™§: ${e.message}</div>`;
            return;
          }

          const connectionStatus = document.getElementById('connection-status');
          if (!connectionStatus || !connectionStatus.textContent) {
            purchaseStatus.innerHTML = `<div class="status error">Êâæ‰∏çÂà∞Â∑≤ÈÄ£Êé•Èå¢ÂåÖÂú∞ÂùÄÔºåË´ãÂÖàÈÄ£Êé•Èå¢ÂåÖ„ÄÇ</div>`;
            return;
          }

          const prefix = 'Â∑≤ÈÄ£Êé•Âà∞Èå¢ÂåÖÔºö';
          let signerAddress = connectionStatus.textContent.trim();
          if (signerAddress.startsWith(prefix)) {
            signerAddress = signerAddress.slice(prefix.length).trim();
          }

          if (!ethers.utils.isAddress(signerAddress)) {
            purchaseStatus.innerHTML = `<div class="status error">Èå¢ÂåÖÂú∞ÂùÄÊ†ºÂºèÈåØË™§: ${signerAddress}</div>`;
            return;
          }

          console.log("Êé•Êî∂ËÄÖÈå¢ÂåÖÂú∞ÂùÄ:", signerAddress);
          // console.log("Ê∏ÖÁêÜÂæåÁöÑ UID:", cleanUID);
          console.log("ÂÇ≥ÂÖ• UID:", uid);

          // ‰ΩøÁî®Êõ¥Â§ßÁöÑ gas limit ‰ª•ÈÅøÂÖç‰∫§ÊòìÂ§±Êïó
          const gasLimit = 800000;

          try {
            const returnedUidCheck = await contract.callStatic.purchaseSpecificCard(uid, signerAddress, {
              value: valueForTx,
              gasLimit: gasLimit,
            });
            console.log("Ê®°Êì¨ÊàêÂäüÔºåËøîÂõûUID:", returnedUidCheck);
          } catch (staticError) {
            const reason = ethers.utils.toUtf8String("0x" + err.data.substr(138));
            console.error("ÂêàÁ∫¶ÂõûÈÄÄÂéüÂõ†Ôºö", reason);
            console.warn("Ê®°Êì¨Â§±ÊïóÔºåÂèØËÉΩ‰∫§ÊòìÊúÉ revert:", staticError);
            // ‰∏çË¶ÅÁõ¥Êé•ËøîÂõûÔºåÁπºÁ∫åÂòóË©¶ÂØ¶Èöõ‰∫§Êòì
          }

          const tx = await contract.purchaseSpecificCard(uid, signerAddress, {
            value: valueForTx,
            gasLimit: gasLimit,
          });
          console.log("‰∫§ÊòìÁôºÈÄÅ:", tx);

          const receipt = await tx.wait();
          console.log("‰∫§ÊòìÁ¢∫Ë™ç:", receipt);

          try {
            const tokenId = await contract.uidToTokenId(uid);
            console.log("Â∞çÊáâ tokenId:", tokenId.toString());

            const tx2 = await contract.recordPrimaryTrade(uid, tokenId, signerAddress, valueForTx);
            await tx2.wait();
            console.log("‚úÖ ‰∏ÄÊâã‰∫§ÊòìÂ∑≤Ë®òÈåÑÂà∞ TradeManager");
          } catch (e) {
            console.warn("‚ö†Ô∏è ÁÑ°Ê≥ïË®òÈåÑ‰∏ÄÊâã‰∫§Êòì:", e.message);
          }

          purchaseStatus.innerHTML = `
          <div class="status success">
            <p>Ë≥ºË≤∑ÊàêÂäüÔºÅ</p>
            <p>Ë´ãÊéÉÊèèÊàñËº∏ÂÖ•Âç°Áâá UID</p>
            <p>‰∏¶Êåâ‰∏ã„ÄåÁ∂ÅÂÆöÂç°Áâá„ÄçÊåâÈàï‰ª•Á∂Å‰∏ä„ÄÇ</p>
          </div>
        `;

          const cardUidInput = document.getElementById('card-uid');
          if (cardUidInput) {
            cardUidInput.value = uid;
          }

          await loadAvailableCardsMarket();

        } catch (error) {
          console.error("Ë≥ºË≤∑Âç°ÁâáÂ§±Êïó:", error);
          let errorMessage = error.message || "Êú™Áü•ÈåØË™§";

          if (error.code === 'ACTION_REJECTED') {
            errorMessage = "‰∫§ÊòìË¢´Áî®Êà∂ÊãíÁµï";
          } else if (error.code === 'CALL_EXCEPTION') {
            errorMessage = "ÂêàÁ¥ÑÂü∑Ë°åÈåØË™§ÔºåË´ãÁ¢∫Ë™çÈå¢ÂåÖÈ§òÈ°çÊàñÂç°ÁâáÁãÄÊÖã";
          } else if (error.code === 'UNPREDICTABLE_GAS_LIMIT') {
            errorMessage = "Gas ‰º∞ÁÆóÂ§±ÊïóÔºåÂèØËÉΩÊòØÂêàÁ¥ÑÁãÄÊÖãÂïèÈ°å";
          } else if (error.message.includes('insufficient funds')) {
            errorMessage = "Èå¢ÂåÖÈ§òÈ°ç‰∏çË∂≥";
          }

          purchaseStatus.innerHTML = `<div class="status error">Ë≥ºË≤∑Âç°ÁâáÂ§±Êïó: ${errorMessage}</div>`;
        }
      }

      // Ë≥ºË≤∑‰∫åÊâãÂç°Áâá
      async function buyResaleCard(uid, priceWei) {
        const purchaseStatus = document.getElementById('purchase-status');
        try {
          purchaseStatus.innerHTML = '<span>ËôïÁêÜ‰∏≠... <div class="loader"></div></span>';
          purchaseStatus.className = 'status info';

          console.log("Ê∫ñÂÇôË≥ºË≤∑‰∫åÊâãÂç°Áâá:", uid);
          console.log("ÂÉπÊ†º(Wei):", priceWei);

          let valueForTx;
          try {
            valueForTx = ethers.BigNumber.from(priceWei);
          } catch (e) {
            purchaseStatus.innerHTML = `<div class="status error">ÂÉπÊ†ºÊ†ºÂºèÈåØË™§: ${e.message}</div>`;
            purchaseStatus.className = 'status error';
            return;
          }

          const connectionStatus = document.getElementById('connection-status');
          if (!connectionStatus || !connectionStatus.textContent) {
            purchaseStatus.innerHTML = `<div class="status error">Êâæ‰∏çÂà∞Â∑≤ÈÄ£Êé•Èå¢ÂåÖÂú∞ÂùÄÔºåË´ãÂÖàÈÄ£Êé•Èå¢ÂåÖ„ÄÇ</div>`;
            purchaseStatus.className = 'status error';
            return;
          }

          let signerAddress = connectionStatus.textContent.trim();
          const prefix = 'Â∑≤ÈÄ£Êé•Âà∞Èå¢ÂåÖÔºö';
          if (signerAddress.startsWith(prefix)) {
            signerAddress = signerAddress.slice(prefix.length).trim();
          }

          if (!ethers.utils.isAddress(signerAddress)) {
            purchaseStatus.innerHTML = `<div class="status error">Èå¢ÂåÖÂú∞ÂùÄÊ†ºÂºèÈåØË™§: ${signerAddress}</div>`;
            purchaseStatus.className = 'status error';
            return;
          }

          console.log("Êé•Êî∂ËÄÖÈå¢ÂåÖÂú∞ÂùÄ:", signerAddress);
          console.log("ÂÇ≥ÂÖ• UID:", uid);

          const tokenId = await contract.uidToTokenId(uid);
          console.log("Â∞çÊáâ tokenId:", tokenId.toString());

          const seller = await contract.getNFTHolder(uid);
          console.log("Ë≥£ÂÆ∂Âú∞ÂùÄ:", seller);

          try {
            const returnedUidCheck = await contract.callStatic.purchaseResaleCard(uid, signerAddress, {
              value: valueForTx,
              gasLimit: 500000,
            });
            console.log("Ê®°Êì¨ÊàêÂäüÔºåËøîÂõûUID:", returnedUidCheck);
          } catch (staticError) {
            console.warn("Ê®°Êì¨Â§±ÊïóÔºåÂèØËÉΩ‰∫§ÊòìÊúÉ revert:", staticError);
          }

          const tx = await contract.purchaseResaleCard(uid, signerAddress, {
            value: valueForTx,
            gasLimit: 500000,
          });
          console.log("‰∫§ÊòìÁôºÈÄÅ:", tx);

          const receipt = await tx.wait();
          console.log("‰∫§ÊòìÁ¢∫Ë™ç:", receipt);

          try {
            const tx2 = await contract.recordSecondaryTrade(uid, tokenId, seller, receipt.from, valueForTx);
            await tx2.wait();
            console.log("‚úÖ ‰∫åÊâã‰∫§ÊòìÂ∑≤Ë®òÈåÑÂà∞ TradeManager");
          } catch (e) {
            console.warn("‚ö†Ô∏è ÁÑ°Ê≥ïË®òÈåÑ‰∫åÊâã‰∫§Êòì:", e.message);
          }

          purchaseStatus.innerHTML = `
          <div class="status success">
            <p>Ë≥ºË≤∑ÊàêÂäüÔºÅ</p>
            <p>Ë´ãÊéÉÊèèÊàñËº∏ÂÖ•Âç°Áâá UID</p>
            <p>‰∏¶Êåâ‰∏ã„ÄåÁ∂ÅÂÆöÂç°Áâá„ÄçÊåâÈàï‰ª•Á∂Å‰∏ä„ÄÇ</p>
          </div>
        `;

          const cardUidInput = document.getElementById('card-uid');
          if (cardUidInput) {
            cardUidInput.value = uid;
          }

          await loadResaleCardsMarket();

        } catch (error) {
          console.error("Ë≥ºË≤∑‰∫åÊâãÂç°ÁâáÂ§±Êïó:", error);
          let errorMessage = error.message || "Êú™Áü•ÈåØË™§";

          if (error.code === 'ACTION_REJECTED') {
            errorMessage = "‰∫§ÊòìË¢´Áî®Êà∂ÊãíÁµï";
          } else if (error.code === 'CALL_EXCEPTION') {
            errorMessage = "ÂêàÁ¥ÑÂü∑Ë°åÈåØË™§ÔºåË´ãÁ¢∫Ë™çÈå¢ÂåÖÈ§òÈ°çÊàñÂç°ÁâáÁãÄÊÖã";
          }

          purchaseStatus.innerHTML = `<div class="status error">Ë≥ºË≤∑‰∫åÊâãÂç°ÁâáÂ§±Êïó: ${errorMessage}</div>`;
          purchaseStatus.className = 'status error';
        }
      }

      // Á∂ÅÂÆöÂç°Áâá
      async function bindCard() {
        const uid = document.getElementById('card-uid').value.trim();
        const requestStatus = document.getElementById('request-status');

        if (!uid) {
          requestStatus.textContent = 'Ë´ãËº∏ÂÖ•ÊúâÊïàÁöÑÂç°Áâá UID„ÄÇ';
          requestStatus.className = 'status error';
          return;
        }

        try {
          const connectionStatus = document.getElementById('connection-status');
          if (!connectionStatus || !connectionStatus.textContent) {
            requestStatus.innerHTML = `<div class="status error">Êâæ‰∏çÂà∞Â∑≤ÈÄ£Êé•Èå¢ÂåÖÂú∞ÂùÄÔºåË´ãÂÖàÈÄ£Êé•Èå¢ÂåÖ„ÄÇ</div>`;
            requestStatus.className = 'status error';
            return;
          }
          const prefix = 'Â∑≤ÈÄ£Êé•Âà∞Èå¢ÂåÖÔºö';
          let signerAddress = connectionStatus.textContent.trim();
          if (signerAddress.startsWith(prefix)) {
            signerAddress = signerAddress.slice(prefix.length).trim();
          }

          if (!ethers.utils.isAddress(signerAddress)) {
            requestStatus.innerHTML = `<div class="status error">Èå¢ÂåÖÂú∞ÂùÄÊ†ºÂºèÈåØË™§: ${signerAddress}</div>`;
            requestStatus.className = 'status error';
            return;
          }
          requestStatus.innerHTML = '<span>Á∂ÅÂÆö‰∏≠... <div class="loader"></div></span>';
          requestStatus.className = 'status info';

          const tx = await contract.bindCardUID(uid, signerAddress);
          await tx.wait();

          requestStatus.textContent = 'Á∂ÅÂÆöÊàêÂäüÔºÅÊÇ®ÁöÑÂç°ÁâáÂ∑≤ÂÆåÊàêÁ∂ÅÂÆö„ÄÇ';
          requestStatus.className = 'status success';
        } catch (error) {
          console.error("Á∂ÅÂÆöÂç°ÁâáÂ§±Êïó:", error);
          let errorMessage = error.message.replace('execution reverted: ', '');
          requestStatus.textContent = 'Á∂ÅÂÆöÂç°ÁâáÂ§±ÊïóÔºö' + errorMessage;
          requestStatus.className = 'status error';
        }
      }

      // ‰∏äÊû∂‰∫åÊâãÂç°Áâá
      async function resaleCard() {
        const uid = document.getElementById("card-to-sell").value.trim();
        const priceInput = document.getElementById("selling-price").value.trim();
        const statusDiv = document.getElementById("create-trade-status");

        if (!uid || !priceInput) {
          statusDiv.innerHTML = '<div class="status error">Ë´ãÈÅ∏ÊìáÂç°Áâá‰∏¶Ëº∏ÂÖ•ÂÉπÊ†º</div>';
          return;
        }

        try {
          statusDiv.innerHTML = '<span>‰∏äÊû∂‰∏≠... <div class="loader"></div></span>';
          statusDiv.className = 'status info';

          const price = ethers.utils.parseEther(priceInput);
          const tx = await contract.listCardForResale(uid, price);

          statusDiv.innerHTML = `<div class="status info">‰∫§ÊòìÁôºÈÄÅ‰∏≠ (tx: ${tx.hash})</div>`;
          await tx.wait();

          statusDiv.innerHTML = '<div class="status success">‰∏äÊû∂ÊàêÂäüÔºÅ</div>';

          // ÈáçÊñ∞ËºâÂÖ•Áõ∏ÈóúÊï∏Êìö
          await loadMyCardsSecond();
          await loadResaleCardsMarket();
        } catch (err) {
          console.error("‰∏äÊû∂Â§±Êïó", err);
          statusDiv.innerHTML = `<div class="status error">‰∏äÊû∂Â§±ÊïóÔºö${err?.reason || err?.message || "Êú™Áü•ÈåØË™§"}</div>`;
        }
      }

      // Ë≥ºË≤∑Âç°Áâá (Â∏ÇÂ†¥‰∫§Êòì)
      async function buyCard(tradeId, price) {
        try {
          await contract.buyerSign(tradeId, { value: price });
          alert('Ë≥ºË≤∑ÊàêÂäüÔºÅÁ≠âÂæÖË≥£ÂÆ∂Á¢∫Ë™çËΩâÁßª„ÄÇ');
          loadAvailableTradesFirst();
          loadAvailableTradesSecond();
          loadMyTradesSecond();
        } catch (error) {
          console.error("Ë≥ºË≤∑Â§±Êïó:", error);
          alert('Ë≥ºË≤∑Â§±ÊïóÔºö' + error.message.replace('execution reverted: ', ''));
        }
      }

      // Ë≥£ÂÆ∂Á∞ΩÁΩ≤
      async function sellerSign(tradeId) {
        try {
          await contract.sellerSign(tradeId);
          alert('Ë≥£ÂÆ∂Á∞ΩÁΩ≤ÊàêÂäüÔºÅ');
          loadMyTradesSecond();
          loadMySalesFirst();
        } catch (error) {
          console.error("Á∞ΩÁΩ≤Â§±Êïó:", error);
          alert('Á∞ΩÁΩ≤Â§±ÊïóÔºö' + error.message);
        }
      }

      // ÂÆåÊàê‰∫§Êòì
      async function finalize(tradeId) {
        try {
          await contract.finalize(tradeId);
          alert('‰∫§ÊòìÂÆåÊàêÔºÅ');
          loadMyTradesSecond();
        } catch (error) {
          console.error("ÂÆåÊàê‰∫§ÊòìÂ§±Êïó:", error);
          alert('ÂÆåÊàê‰∫§ÊòìÂ§±ÊïóÔºö' + error.message);
        }
      }

      // Ë®≠ÁΩÆÂç°ÁâáÂÉπÊ†º (ÂÉÖÁÆ°ÁêÜÂì°)
      async function setCardPrice() {
        if (!isOwner) {
          alert('Âè™ÊúâÂêàÁ¥ÑÊìÅÊúâËÄÖÂèØ‰ª•Âü∑Ë°åÊ≠§Êìç‰Ωú„ÄÇ');
          return;
        }

        const idolGroup = document.getElementById('idol-group').value.trim();
        const idolMember = document.getElementById('idol-member').value.trim();
        const cardNumber = document.getElementById('card-number').value.trim();
        const listPriceEth = document.getElementById('list-price').value;
        const photoURI = document.getElementById('photo-uri').value.trim();
        const newPriceEth = document.getElementById('new-price').value;
        const amount = document.getElementById('card-amount').value;
        const setPriceStatus = document.getElementById('set-price-status');

        if (!newPriceEth || !idolGroup || !idolMember || !cardNumber || !listPriceEth || !photoURI) {
          setPriceStatus.innerHTML = '<div class="status error">Ë´ãÂÆåÊï¥Ëº∏ÂÖ•ÊâÄÊúâÊ¨Ñ‰Ωç„ÄÇ</div>';
          return;
        }

        try {
          setPriceStatus.innerHTML = '<span>ËôïÁêÜ‰∏≠... <div class="loader"></div></span>';
          setPriceStatus.className = 'status info';

          const newPriceWei = ethers.utils.parseEther(newPriceEth);
          const listPriceWei = ethers.utils.parseEther(listPriceEth);

          const tx = await contract.setCardPrice(
            newPriceWei,
            idolGroup,
            idolMember,
            cardNumber,
            listPriceWei,
            photoURI,
            amount
          );

          await tx.wait();

          setPriceStatus.innerHTML = '<div class="status success">Âç°ÁâáË≥áË®äË®≠ÁΩÆÊàêÂäüÔºÅ</div>';

          // Ê∏ÖÁ©∫Ë°®ÂñÆ
          document.getElementById('idol-group').value = '';
          document.getElementById('idol-member').value = '';
          document.getElementById('card-number').value = '';
          document.getElementById('list-price').value = '';
          document.getElementById('photo-uri').value = '';
          document.getElementById('new-price').value = '';
          document.getElementById('card-amount').value = '';

          // ÈáçÊñ∞ËºâÂÖ•Âç°ÁâáÁµ±Ë®à
          await loadCardStats();
        } catch (error) {
          console.error("Ë®≠ÁΩÆÂç°ÁâáË≥áË®äÂ§±Êïó:", error);
          setPriceStatus.innerHTML = `<div class="status error">Ë®≠ÁΩÆÂç°ÁâáË≥áË®äÂ§±ÊïóÔºö${error.message.replace('execution reverted: ', '')}</div>`;
        }
      }

      // ÂØ©ÊâπÂç°ÁâáË´ãÊ±Ç (ÂÉÖÁÆ°ÁêÜÂì°)
      async function approveTransfer(uid) {
        if (!isOwner) {
          alert('Âè™ÊúâÂêàÁ¥ÑÊìÅÊúâËÄÖÂèØ‰ª•Âü∑Ë°åÊ≠§Êìç‰Ωú„ÄÇ');
          return;
        }

        try {
          await contract.approveTransfer(uid);
          alert('ÂØ©ÊâπÊàêÂäüÔºÅ');
          loadPendingRequests();
        } catch (error) {
          console.error("ÂØ©ÊâπÂ§±Êïó:", error);
          alert('ÂØ©ÊâπÂ§±ÊïóÔºö' + error.message.replace('execution reverted: ', ''));
        }
      }

      // ÊãíÁµïÂç°ÁâáË´ãÊ±Ç (ÂÉÖÁÆ°ÁêÜÂì°)
      async function rejectTransfer(uid) {
        if (!isOwner) {
          alert('Âè™ÊúâÂêàÁ¥ÑÊìÅÊúâËÄÖÂèØ‰ª•Âü∑Ë°åÊ≠§Êìç‰Ωú„ÄÇ');
          return;
        }

        try {
          await contract.rejectTransfer(uid);
          alert('Â∑≤ÊãíÁµïÊ≠§Ë´ãÊ±ÇÔºÅ');
          loadPendingRequests();
        } catch (error) {
          console.error("ÊãíÁµïË´ãÊ±ÇÂ§±Êïó:", error);
          alert('ÊãíÁµïË´ãÊ±ÇÂ§±ÊïóÔºö' + error.message);
        }
      }

      // Êü•ÁúãÂç°ÁâáË©≥ÊÉÖ
      async function viewCardDetails(uid) {
        console.log("üîç Êü•Ë©¢‰∫§ÊòìÁ¥ÄÈåÑ for UID:", uid);
        const modal = document.getElementById('card-modal');
        const content = document.getElementById('card-modal-content');
        modal.style.display = 'flex';
        content.innerHTML = '<p>ËºâÂÖ•‰∏≠... <div class="loader"></div></p>';

        try {
          console.log("üîç Êü•ÁúãÂç°ÁâáË©≥ÊÉÖÔºåUID:", uid);

          if (!contract) {
            content.innerHTML = '<p class="error">ÂêàÁ¥ÑÂ∞öÊú™ÈÄ£Êé•ÔºåË´ãÂÖàÈÄ£Êé•Èå¢ÂåÖ„ÄÇ</p>';
            return;
          }

          console.log("üöÄ ÂëºÂè´ getTradesByUID...");
          const trades = await contract.getTradesByUID(uid);
          console.log("‚úÖ ÊàêÂäüÂèñÂæó‰∫§ÊòìË≥áÊñô:", trades);

          if (!trades || trades.length === 0) {
            content.innerHTML = `
            <h3>Âç°ÁâáË©≥ÊÉÖ</h3>
            <p>‚ùóÔ∏è Ê≠§Âç°ÁâáÂ∞öÊú™Êúâ‰∫§ÊòìÁ¥ÄÈåÑ„ÄÇ</p>
            <p><em>ÊèêÁ§∫ÔºöÂ¶ÇÊûúÈÄôÊòØÂâõË≥ºË≤∑ÁöÑÂç°ÁâáÔºå‰∫§ÊòìÁ¥ÄÈåÑÂèØËÉΩÈúÄË¶ÅÂπæÂàÜÈêòÊâçÊúÉÂá∫Áèæ„ÄÇ</em></p>
          `;
            return;
          }

          let html = `
          <h3>Âç°Áâá‰∫§ÊòìÊ≠∑Âè≤</h3>
          <table class="modern-table">
            <thead>
              <tr><th>‰∫§Êòì ID</th><th>Ë≤∑ÂÆ∂</th><th>Ë≥£ÂÆ∂</th><th>ÂÉπÊ†º</th><th>ÁãÄÊÖã</th><th>ÊôÇÈñì</th></tr>
            </thead>
            <tbody>
        `;

          for (const trade of trades) {
            const buyer = trade.buyer ? `${trade.buyer.slice(0, 6)}...${trade.buyer.slice(-4)}` : '‚Äî';
            const seller = trade.seller ? `${trade.seller.slice(0, 6)}...${trade.seller.slice(-4)}` : '‚Äî';
            const priceEth = ethers.utils.formatEther(trade.price);
            const time = trade.timestamp > 0 ? new Date(trade.timestamp * 1000).toLocaleString() : '‚Äî';
            const statusText = getStatusLabel(trade.status);

            html += `<tr>
            <td>#${trade.tradeId}</td>
            <td>${buyer}</td>
            <td>${seller}</td>
            <td>${priceEth} ETH</td>
            <td>${statusText}</td>
            <td>${time}</td>
          </tr>`;
          }

          html += `</tbody></table>`;
          content.innerHTML = html;

        } catch (err) {
          console.error("‚ùå ËºâÂÖ•‰∫§ÊòìË©≥ÊÉÖÂ§±Êïó:", err);
          content.innerHTML = `
          <h3>ÈåØË™§Ë©≥ÊÉÖ</h3>
          <p class="error">ÁÑ°Ê≥ïÂèñÂæó‰∫§ÊòìÁ¥ÄÈåÑ</p>
          <details>
            <summary>ÊäÄË°ìÁ¥∞ÁØÄ</summary>
            <pre>${err.message}</pre>
          </details>
          <p><em>Ë´ãÁ¢∫Ë™çÔºö</em></p>
          <ul>
            <li>ÂêàÁ¥ÑÊòØÂê¶Ê≠£Á¢∫ÈÉ®ÁΩ≤</li>
            <li>UID ÊòØÂê¶Ê≠£Á¢∫</li>
            <li>ÊòØÂê¶ÊúâÊ¨äÈôêÂ≠òÂèñÊ≠§Ë≥áÊñô</li>
          </ul>
        `;
        }
      }

      // Áç≤ÂèñÁãÄÊÖãÊ®ôÁ±§
      function getStatusLabel(status) {
        const baseStyle = 'white-space: nowrap; display: inline-block; min-width: 70px; text-align: center; padding: 0.5rem 1rem;';

        switch (status) {
          case 0: return '<span class="trade-status status-created">Â∑≤ÂâµÂª∫</span>';
          case 1: return '<span class="trade-status status-buyer-signed">Ë≤∑ÂÆ∂Â∑≤Á∞ΩÁΩ≤</span>';
          case 2: return '<span class="trade-status status-seller-signed">Ë≥£ÂÆ∂Â∑≤Á∞ΩÁΩ≤</span>';
          case 5: return '<span class="trade-status status-completed">Â∑≤ÂÆåÊàê</span>';
          default: return `<span class="trade-status">ÁãÄÊÖã ${status}</span>`;
        }
      }

      // ÂàùÂßãÂåñÊ®ôÁ±§È†ÅÂàáÊèõ
      function initTabs() {
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');

        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            // ÁßªÈô§ÊâÄÊúâÊ®ôÁ±§È†ÅÁöÑ active È°û
            tabs.forEach(t => t.classList.remove('active'));
            tabContents.forEach(tc => tc.classList.remove('active'));

            // ÁÇ∫Áï∂ÂâçÊ®ôÁ±§È†ÅÊ∑ªÂä† active È°û
            tab.classList.add('active');
            const tabId = tab.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');

            // Â¶ÇÊûúÂàáÊèõÂà∞ÈÅéÂæÄ‰∫§Êòì tabÔºåËºâÂÖ•Ë®òÈåÑ
            if (tabId === 'history' && contract && userAccount) {
              loadHistoryRecords();
            }
          });
        });
      }

      // ÈóúÈñâÊ®°ÊÖãÊ°Ü
      document.getElementById('card-modal-close').addEventListener('click', () => {
        const modal = document.getElementById('card-modal');
        if (modal) {
          modal.style.display = 'none';
        }
      });

      // ÈªûÊìäÊ®°ÊÖãÊ°ÜËÉåÊôØÈóúÈñâ
      document.getElementById('card-modal').addEventListener('click', (e) => {
        if (e.target.id === 'card-modal') {
          e.target.style.display = 'none';
        }
      });

      // Â∞á rejectTransfer Ê∑ªÂä†Âà∞ window Â∞çË±°
      window.rejectTransfer = rejectTransfer;

      // Ê∏¨Ë©¶ÂêàÁ¥ÑÂäüËÉΩ
      async function testContractFunctions() {
        console.log("ÈñãÂßãÊ∏¨Ë©¶ÂêàÁ¥ÑÂäüËÉΩ...");

        try {
          console.log("ÂêàÁ¥ÑÂØ¶‰æã:", contract);
          console.log("ÂêàÁ¥Ñ ABI:", contractABI);

          console.log("ÂòóË©¶Áç≤ÂèñÂèØÁî®Âç°Áâá...");
          const cards = await contract.getAvailableCards();
          console.log("ÂèØÁî®Âç°Áâá:", cards);

          console.log("Ê™¢Êü•‰∫ã‰ª∂ÂÆöÁæ©...");
          const filter = contract.filters.CardPurchased();
          console.log("CardPurchased ‰∫ã‰ª∂ÈÅéÊøæÂô®:", filter);

          const balance = await window.ethereum.request({
            method: 'eth_getBalance',
            params: [userAccount, 'latest']
          });
          console.log("Èå¢ÂåÖÈ§òÈ°ç:", ethers.utils.formatEther(balance), "ETH");

          console.log("Ê∏¨Ë©¶ÂÆåÊàê");
        } catch (error) {
          console.error("ÂêàÁ¥ÑÂäüËÉΩÊ∏¨Ë©¶Â§±Êïó:", error);
        }
      }

      // Â∞áÊ∏¨Ë©¶ÂáΩÊï∏Ê∑ªÂä†Âà∞ window Â∞çË±°
      window.testContractFunctions = testContractFunctions;
      window.testGetResaleCards = async function () {
        const cards = await contract.getResaleCards();
        console.log("‰∫åÊâãÂç°ÁâáÔºö", cards);
      };

      let cardManagerContract;

      async function checkCardManagerOwner() {
        if (!contract || !userAccount) {
          console.log("ÂêàÁ¥ÑÊàñÁî®Êà∂Â∏≥ËôüÂ∞öÊú™ÂàùÂßãÂåñ");
          return;
        }

        try {
          const cardManagerAbi = [
            "function owner() view returns (address)"
          ];

          const provider = contract.provider;
          const signer = provider.getSigner(userAccount);

          const cardManagerContract = new ethers.Contract(cardManagerAddress, cardManagerAbi, signer);

          const ownerAddress = await cardManagerContract.owner();
          console.log("CardManager ÂêàÁ¥ÑÊìÅÊúâËÄÖ:", ownerAddress);
          console.log("ÁõÆÂâçÈå¢ÂåÖÂú∞ÂùÄ:", userAccount);

          if (ownerAddress.toLowerCase() === userAccount.toLowerCase()) {
            console.log("‰Ω†ÊòØ CardManager ÁöÑÊìÅÊúâËÄÖÔºåÂèØ‰ª•Âü∑Ë°åÁÆ°ÁêÜÊìç‰Ωú„ÄÇ");
          } else {
            console.warn("‰Ω†‰∏çÊòØ CardManager ÁöÑÊìÅÊúâËÄÖÔºåÁÆ°ÁêÜÊìç‰ΩúÊúÉË¢´ÊãíÁµïÔºÅ");
          }
        } catch (error) {
          console.error("Ê™¢Êü• CardManager ÊìÅÊúâËÄÖÂ§±Êïó:", error);
        }
      }
    </script>
</body>

</html>